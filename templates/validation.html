{% extends "base.html" %}

{% block title %}Validazione Step-by-Step{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white tracking-tight">Validazione a Step</h2>
                <div class="flex gap-3">
                 <span id="stepStatus"
                       class="hidden px-3 py-1 rounded-full text-xs font-bold bg-indigo-600 text-white border border-indigo-400 shadow-[0_0_10px_rgba(79,70,229,0.5)]">
                    Step <span id="currentStepDisp">1</span> di <span id="totalStepsDisp">?</span>
                </span>
                    <span id="camStatus"
                          class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-800 text-slate-400 border border-slate-700">Inizializzazione...</span>
                </div>
            </div>

            <div class="bg-black rounded-2xl overflow-hidden shadow-2xl border border-[#2e3054] relative group">
                <div class="video-container relative w-full bg-black aspect-video flex items-center justify-center">
                    <video id="videoElement" autoplay playsinline class="w-full h-full object-contain rounded"></video>
                    <canvas id="overlayCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                </div>

                <div class="accuracy-panel hidden absolute top-4 right-4 bg-gradient-to-r from-indigo-900/90 to-purple-900/90 backdrop-blur-md p-4 rounded-xl border border-indigo-500/30 transition-all duration-300 z-10"
                     id="accuracyPanel">
                    <div class="flex items-center gap-4">
                        <div class="relative w-16 h-16 flex-shrink-0">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent"
                                        class="text-slate-700"/>
                                <circle id="lockProgressRing" cx="32" cy="32" r="28" stroke="currentColor"
                                        stroke-width="4" fill="transparent"
                                        class="text-green-400 transition-all duration-200" stroke-dasharray="175"
                                        stroke-dashoffset="175"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-bold text-white" id="accuracyValue">0%</span>
                            </div>
                        </div>
                        <div>
                            <h5 class="text-indigo-200 text-xs uppercase tracking-wider font-semibold mb-1"
                                id="groupActionText">Allineamento</h5>
                            <p class="text-lg font-bold text-white leading-tight mb-1" id="accuracyMessage">In
                                attesa...</p>
                        </div>
                    </div>
                </div>

                <div id="stepSuccessOverlay"
                     class="hidden absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-20">
                    <div class="text-center transform transition-all scale-110">
                        <i class="bi bi-check-circle-fill text-6xl text-green-500 mb-4 inline-block shadow-green-500 drop-shadow-lg"></i>
                        <h3 class="text-3xl font-bold text-white">Step Completato!</h3>
                    </div>
                </div>

                <div id="finalSuccessOverlay"
                     class="hidden absolute inset-0 bg-gradient-to-b from-black/80 to-green-900/40 backdrop-blur-md flex items-center justify-center z-30">
                    <div class="text-center p-8 bg-[#161831] border border-green-500/50 rounded-2xl shadow-2xl">
                        <i class="bi bi-trophy-fill text-6xl text-yellow-400 mb-4 inline-block"></i>
                        <h3 class="text-3xl font-bold text-white">Validazione Terminata!</h3>
                        <p class="text-slate-300 mt-4 mb-6">Tutti i sensori sono stati posizionati correttamente.</p>
                        <button onclick="location.reload()"
                                class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition">
                            Nuova Sessione
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex flex-wrap gap-4 items-center bg-[#161831] p-4 rounded-xl border border-[#2e3054]">
                <button id="startBtn"
                        class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow-lg shadow-green-900/20 transition-all flex items-center gap-2">
                    <i class="bi bi-play-fill text-xl"></i> Avvia
                </button>
                <button id="stopBtn"
                        class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold shadow-lg shadow-red-900/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        disabled>
                    <i class="bi bi-stop-fill text-xl"></i> Ferma
                </button>
                <div class="ml-auto flex items-center gap-4">
                    <button id="skipGroupBtn"
                            class="hidden text-slate-400 hover:text-white text-sm underline decoration-slate-600 underline-offset-4">
                        Salta Step <i class="bi bi-skip-forward-fill"></i>
                    </button>
                </div>
            </div>

            <div class="card mt-4 bg-[#161831] border border-[#2e3054] rounded-xl p-4">
                <label for="opacitySlider" class="text-sm text-slate-300 mb-2 block">
                    Opacità Overlay: <span id="opacityValue" class="text-indigo-400 font-bold">50</span>%
                </label>
                <input type="range"
                       class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                       id="opacitySlider" min="0" max="100" step="5" value="50">
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl p-6">
                <h4 class="text-white font-semibold mb-4 flex items-center gap-2">
                    <i class="bi bi-image text-indigo-400"></i> Riferimento
                </h4>
                <div id="referencePreview">
                    <div class="text-center py-8 border-2 border-dashed border-slate-700 rounded-xl">
                        <h5 class="text-white mt-2 font-medium">Nessun Riferimento</h5>
                        <a href="/upload"
                           class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded-lg transition inline-flex items-center mt-2">
                            <i class="bi bi-upload me-2"></i> Carica
                        </a>
                    </div>
                </div>
            </div>

            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl p-6">
                <h5 class="text-white font-semibold mb-4 border-b border-[#2e3054] pb-2">Stato Sessione</h5>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-[#0f1021] rounded-lg">
                        <strong class="text-slate-400 text-sm">Step Totali:</strong>
                        <span id="sessionTotalSteps" class="text-indigo-400 font-mono font-bold">-</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        let cleanReferenceImage = null;
        let validationOverlayImage = null;
        let stepsConfig = null;
        let overlayOpacity = 0.5;

        let isCameraActive = false;
        let isValidating = false;
        let validationIntervalId = null;

        let currentStep = 1;
        let totalSteps = 1;
        let currentAccuracy = 0;
        let lockTimer = 0;
        const LOCK_THRESHOLD = 85;
        const LOCK_DURATION = 1500;
        let lastFrameTime = 0;
        let sensorsRealtimeStatus = {};

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const CIRCUMFERENCE = 175;

        document.addEventListener('DOMContentLoaded', () => {
            loadSession();
            document.getElementById('startBtn').onclick = startValidation;
            document.getElementById('stopBtn').onclick = stopValidation;
            document.getElementById('opacitySlider').oninput = (e) => {
                overlayOpacity = e.target.value / 100;
                document.getElementById('opacityValue').innerText = e.target.value;
            };
            const skipBtn = document.getElementById('skipGroupBtn');
            if (skipBtn) skipBtn.onclick = () => nextStep();

            // UPLOAD HANDLER INTERCEPT
            const uploadLink = document.querySelector('a[href="/upload"]');
            if (uploadLink) {
                uploadLink.onclick = (e) => {
                    e.preventDefault();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (ev) => handleFileUpload(ev.target.files[0]);
                    input.click();
                };
            }
        });

        async function handleFileUpload(file) {
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            document.getElementById('referencePreview').innerHTML = `<div class="text-white animate-pulse">Caricamento...</div>`;

            try {
                const response = await fetch('/upload', {method: 'POST', body: formData});
                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('cleanReferenceImage', `data:image/png;base64,${data.reference_image}`);
                    localStorage.setItem('validationOverlayImage', `data:image/png;base64,${data.drawing_overlay_image}`);
                    localStorage.setItem('referenceMetadata', JSON.stringify(data));

                    // Reload internal vars
                    cleanReferenceImage = new Image();
                    cleanReferenceImage.src = `data:image/png;base64,${data.reference_image}`;
                    validationOverlayImage = new Image();
                    validationOverlayImage.src = `data:image/png;base64,${data.drawing_overlay_image}`;

                    stepsConfig = data.steps_config || {};
                    const dictLen = Object.keys(stepsConfig).length;
                    const listLen = data.sensors_data ? Math.ceil(data.sensors_data.length / 2) : 1;
                    totalSteps = Math.max(dictLen, listLen, data.total_steps || 1);

                    // Update UI
                    document.getElementById('totalStepsDisp').innerText = totalSteps;
                    document.getElementById('sessionTotalSteps').innerText = totalSteps;
                    document.getElementById('referencePreview').innerHTML = `<img src="${validationOverlayImage.src}" class="w-3/4 mx-auto rounded border border-slate-600">`;
                    document.getElementById('startBtn').disabled = false;

                    validationOverlayImage.onload = () => {
                        initCamera();
                        resizeCanvas();
                    }
                    alert(`Upload OK: ${data.message}`);
                } else {
                    alert("Errore: " + data.error);
                }
            } catch (e) {
                alert("Errore di rete");
            }
        }

        function loadSession() {
            const refSrc = localStorage.getItem('cleanReferenceImage');
            const ovlSrc = localStorage.getItem('validationOverlayImage');
            const meta = localStorage.getItem('referenceMetadata');

            if (refSrc && ovlSrc && meta) {
                cleanReferenceImage = new Image();
                cleanReferenceImage.src = refSrc;
                validationOverlayImage = new Image();
                validationOverlayImage.src = ovlSrc;
                let metadata;
                try {
                    metadata = JSON.parse(meta);
                } catch (e) {
                    return;
                }

                stepsConfig = metadata.steps_config || {};
                const dictLen = Object.keys(stepsConfig).length;
                const listLen = metadata.sensors_data ? Math.ceil(metadata.sensors_data.length / 2) : 1;
                totalSteps = Math.max(dictLen, listLen, metadata.total_steps || 1);

                document.getElementById('totalStepsDisp').innerText = totalSteps;
                document.getElementById('sessionTotalSteps').innerText = totalSteps;
                document.getElementById('referencePreview').innerHTML = `<img src="${ovlSrc}" class="w-3/4 mx-auto rounded border border-slate-600">`;

                validationOverlayImage.onload = () => {
                    initCamera();
                    resizeCanvas();
                };
                document.getElementById('startBtn').disabled = false;
            }
        }

        async function initCamera() {
            if (isCameraActive || !window.sensorApp) return;
            await window.sensorApp.initializeCameraWithAdaptiveResolution(null, validationOverlayImage);
            isCameraActive = true;
            document.getElementById('camStatus').innerText = "Camera OK";
            document.getElementById('camStatus').className = "px-3 py-1 rounded-full text-xs font-semibold bg-green-900 text-green-200 border border-green-700";
            requestAnimationFrame(drawLoop);
        }

        function startValidation() {
            if (!isCameraActive) return;
            isValidating = true;
            currentStep = 1;
            lockTimer = 0;
            updateUI();

            document.getElementById('stepStatus').classList.remove('hidden');
            document.getElementById('skipGroupBtn').classList.remove('hidden');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            validationIntervalId = setInterval(validateBackend, 500);
        }

        function stopValidation() {
            isValidating = false;
            clearInterval(validationIntervalId);
            document.getElementById('accuracyPanel').classList.add('hidden');
            document.getElementById('stepStatus').classList.add('hidden');
            document.getElementById('skipGroupBtn').classList.add('hidden');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        async function validateBackend() {
            if (!isValidating) return;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            const frame = tempCanvas.toDataURL('image/jpeg', 0.6);
            const meta = JSON.parse(localStorage.getItem('referenceMetadata'));

            try {
                const res = await fetch('/api/validate_frame', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: meta ? meta.session_id : 'default',
                        reference_image: cleanReferenceImage.src,
                        current_frame: frame,
                        current_step: currentStep
                    })
                });
                const data = await res.json();

                if (data.success) {
                    currentAccuracy = data.accuracy;
                    document.getElementById('accuracyValue').innerText = Math.round(data.accuracy) + '%';
                    document.getElementById('accuracyMessage').innerText = data.message;
                    document.getElementById('accuracyPanel').classList.remove('hidden');

                    if (data.sensors_status) {
                        data.sensors_status.forEach(s => sensorsRealtimeStatus[s.id] = s.present);
                    }

                    if (currentAccuracy >= LOCK_THRESHOLD) {
                        lockTimer += 500;
                        if (lockTimer >= LOCK_DURATION) nextStep();
                    } else {
                        lockTimer = 0;
                    }
                    updateLockRing();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function nextStep() {
            lockTimer = 0;
            document.getElementById('stepSuccessOverlay').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('stepSuccessOverlay').classList.add('hidden');
                currentStep++;
                if (currentStep > totalSteps) {
                    stopValidation();
                    document.getElementById('finalSuccessOverlay').classList.remove('hidden');
                }
                updateUI();
            }, 1000);
        }

        function drawLoop() {
            if (!isCameraActive) return;
            resizeCanvas();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.globalAlpha = overlayOpacity;
            const dims = getDrawDimensions();
            if (validationOverlayImage) ctx.drawImage(validationOverlayImage, dims.x, dims.y, dims.w, dims.h);

            if (isValidating && stepsConfig) {
                const scale = dims.w / validationOverlayImage.naturalWidth;

                Object.keys(stepsConfig).forEach(stepKey => {
                    const stepNum = parseInt(stepKey);
                    const sensorsInStep = stepsConfig[stepKey];

                    sensorsInStep.forEach(s => {
                        const cx = dims.x + (s.x * scale);
                        const cy = dims.y + (s.y * scale);
                        const r = s.r * scale;
                        const isPresent = sensorsRealtimeStatus[s.id];

                        ctx.lineWidth = 3;

                        if (stepNum < currentStep) {
                            ctx.globalAlpha = 0.6;
                            ctx.strokeStyle = '#22c55e';
                            ctx.beginPath();
                            ctx.arc(cx, cy, r, 0, Math.PI * 2);
                            ctx.stroke();
                            ctx.fillStyle = '#fff';
                            ctx.font = '20px Arial';
                            ctx.fillText("✓", cx - 6, cy + 6);
                        } else if (stepNum === currentStep) {
                            ctx.globalAlpha = 1.0;
                            if (isPresent) {
                                ctx.strokeStyle = '#4ade80';
                                ctx.shadowBlur = 15;
                                ctx.shadowColor = '#4ade80';
                            } else {
                                const pulse = 1 + Math.sin(Date.now() / 200) * 0.1;
                                ctx.strokeStyle = '#ef4444';
                                ctx.shadowBlur = 20;
                                ctx.shadowColor = '#ef4444';
                                r_pulse = r * pulse;
                                ctx.beginPath();
                                ctx.arc(cx, cy, r_pulse, 0, Math.PI * 2);
                                ctx.stroke();
                                ctx.font = 'bold 12px Arial';
                                ctx.fillStyle = '#ef4444';
                                ctx.fillText("MANCA", cx - 20, cy - r - 5);
                                return;
                            }
                            ctx.beginPath();
                            ctx.arc(cx, cy, r, 0, Math.PI * 2);
                            ctx.stroke();
                            ctx.shadowBlur = 0;
                            ctx.fillStyle = '#fff';
                            ctx.fillText(s.id, cx - 4, cy + 4);
                        } else {
                            ctx.globalAlpha = 0.2;
                            ctx.strokeStyle = '#94a3b8';
                            ctx.beginPath();
                            ctx.arc(cx, cy, r, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    });
                });
            }
            requestAnimationFrame(drawLoop);
        }

        function updateUI() {
            const safeStep = currentStep > totalSteps ? totalSteps : currentStep;
            document.getElementById('currentStepDisp').innerText = safeStep;
            const pct = ((safeStep - 1) / totalSteps) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
        }

        function updateLockRing() {
            const progress = Math.min(lockTimer / LOCK_DURATION, 1);
            const offset = CIRCUMFERENCE - (progress * CIRCUMFERENCE);
            document.getElementById('lockProgressRing').style.strokeDashoffset = offset;
        }

        function getDrawDimensions() {
            const iw = validationOverlayImage.naturalWidth;
            const ih = validationOverlayImage.naturalHeight;
            const cw = canvas.width;
            const ch = canvas.height;
            const scale = Math.min(cw / iw, ch / ih);
            const w = iw * scale;
            const h = ih * scale;
            return {x: (cw - w) / 2, y: (ch - h) / 2, w: w, h: h};
        }

        function resizeCanvas() {
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
        }
    </script>
{% endblock %}