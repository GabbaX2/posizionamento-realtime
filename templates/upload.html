{% extends "base.html" %}

{% block title %}Carica Riferimento - Sensor Placement Validator{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-10">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Carica Immagine di Riferimento</h1>
        <p class="text-slate-400">Carica una foto chiara dell'arto (vista anteriore o posteriore).</p>
    </div>

    <div class="bg-[#161831] border border-[#2e3054] rounded-2xl shadow-xl overflow-hidden">
        <div class="p-1 bg-gradient-to-r from-indigo-500/20 to-cyan-500/20"></div>

        <div class="p-6 md:p-8">
            <form id="uploadForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                <input type="hidden" name="limb_type" value="leg">
                <input type="hidden" name="view_type" value="anterior">

                <div class="mb-8 p-4 bg-[#0f1021] rounded-xl border border-[#2e3054] flex items-center justify-between">
                    <div>
                        <h3 class="text-white font-medium flex items-center gap-2">
                            <i class="bi bi-scissors text-indigo-400"></i> Rimuovi Sfondo
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">Richiesto per l'analisi dei contorni.</p>
                    </div>
                    <div class="form-check form-switch relative">
                         <input class="form-check-input h-6 w-11 rounded-full bg-slate-700 border-transparent cursor-pointer transition-colors ease-in-out duration-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none" type="checkbox" id="removeBackground" checked>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Immagine di Riferimento</label>

                    <div class="file-upload-area relative border-2 border-dashed border-slate-600 bg-slate-800/30 hover:bg-slate-800/50 hover:border-indigo-500 rounded-xl p-10 text-center transition-all cursor-pointer group flex flex-col items-center justify-center min-h-[220px]">

                        <div class="space-y-4">
                            <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto group-hover:bg-indigo-500/20 transition-colors">
                                <i class="bi bi-cloud-arrow-up text-3xl text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium text-white">Trascina qui l'immagine</h4>
                                <p class="text-slate-500 text-sm mt-1">oppure</p>
                            </div>

                            <input class="d-none" type="file" id="referenceImage" name="file" accept="image/*" required>

                            <button type="button" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-indigo-500/20" onclick="document.getElementById('referenceImage').click()">
                                <i class="bi bi-folder2-open me-2"></i>Scegli File
                            </button>
                        </div>

                        <p class="text-xs text-slate-600 mt-6">JPG, PNG, WebP (Max 10MB)</p>
                    </div>

                    <div id="fileInfo" class="mt-4 d-none">
                        <div class="flex items-center gap-3 p-3 bg-indigo-900/20 border border-indigo-500/30 rounded-lg text-indigo-200 text-sm">
                            <i class="bi bi-info-circle flex-shrink-0"></i>
                            <span id="fileName"></span>
                        </div>
                    </div>
                </div>

                <div id="processingStatus" class="mb-6 d-none">
                    <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="spinner-border text-yellow-500 w-5 h-5" role="status">
                                <span class="visually-hidden">...</span>
                            </div>
                            <div>
                                <h6 class="text-yellow-200 font-medium text-sm" id="processingTitle">Elaborazione...</h6>
                                <p class="text-yellow-400/70 text-xs" id="processingMessage">Attendere prego</p>
                            </div>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-yellow-500 h-1.5 rounded-full transition-all duration-300 progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="processingProgress"></div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-900/50 transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" id="uploadBtn">
                    <i class="bi bi-cloud-upload me-2"></i>
                    <span class="upload-text">Carica Immagine</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="uploadSpinner"></div>
                </button>
            </form>
        </div>
    </div>

    <div id="uploadResult" class="mt-6"></div>

    <div class="text-center mt-6">
        <button type="button" class="text-slate-400 hover:text-red-400 text-sm transition-colors flex items-center justify-center gap-2 mx-auto" onclick="clearAllReferenceData()">
            <i class="bi bi-trash3"></i> Cancella Riferimento Salvato
        </button>
    </div>

    <div id="referencePreview" class="mt-12 d-none">
        <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
            <div class="px-6 py-4 border-b border-[#2e3054] bg-[#0f1021]/50">
                <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i class="bi bi-eye text-indigo-400"></i> Anteprima Immagine
                </h4>
            </div>
            <div class="p-6">
                <div class="flex flex-col items-center">
                    <img id="previewImage" src="" alt="Preview" class="max-h-[50vh] rounded-lg shadow-2xl border border-slate-700 cursor-zoom-in transition-transform hover:scale-[1.01] preview-image">
                    <p class="text-slate-500 text-xs mt-3"><i class="bi bi-zoom-in"></i> Tocca per ingrandire</p>
                </div>
                <div id="previewInfo" class="row mt-6 text-center g-4"></div>
            </div>
        </div>
    </div>

    <div id="detectionResults" class="mt-8 d-none">
        <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
            <div class="px-6 py-4 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border-b border-[#2e3054]">
                <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i class="bi bi-geo-alt text-cyan-400"></i> Contorni e Sensori
                </h4>
            </div>

            <div class="p-6">
                <ul class="nav nav-tabs flex border-b border-[#2e3054] mb-6" id="imageTabs" role="tablist">
                    <li class="nav-item mr-1" role="presentation">
                        <button class="nav-link active bg-transparent text-slate-400 hover:text-white border-transparent hover:border-indigo-500 px-4 py-2 font-medium" id="original-tab" data-bs-toggle="tab" data-bs-target="#original-pane" type="button" role="tab">
                            <i class="bi bi-image me-1"></i>Originale
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link bg-transparent text-slate-400 hover:text-white border-transparent hover:border-indigo-500 px-4 py-2 font-medium" id="annotated-tab" data-bs-toggle="tab" data-bs-target="#annotated-pane" type="button" role="tab">
                            <i class="bi bi-lightbulb-fill me-1"></i>Rilevamento
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="imageTabsContent">
                    <div class="tab-pane fade show active" id="original-pane" role="tabpanel">
                        <div class="text-center">
                            <img id="originalImage" src="" alt="Originale" class="img-fluid rounded shadow-lg max-h-[60vh] cursor-zoom-in">
                        </div>
                    </div>

                    <div class="tab-pane fade" id="annotated-pane" role="tabpanel">
                        <div class="text-center mb-6">
                            <img id="annotatedImage" src="" alt="Annotata" class="img-fluid rounded shadow-lg max-h-[60vh] cursor-zoom-in border border-indigo-500/30">
                        </div>

                        <div class="bg-[#0f1021] rounded-xl p-6 border border-[#2e3054]">
                            <h5 class="text-white font-medium mb-4"><i class="bi bi-info-circle-fill text-indigo-500 me-2"></i>Legenda</h5>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="border-l-4 border-green-500 pl-4">
                                    <h6 class="font-bold text-white mb-2">Contorno Gamba</h6>
                                    <div class="flex items-center">
                                        <span class="w-5 h-5 border-2 border-green-500 block me-3"></span>
                                        <span class="text-slate-400 text-sm">Verde (Perimetro)</span>
                                    </div>
                                </div>
                                <div class="border-l-4 border-red-500 pl-4">
                                    <h6 class="font-bold text-white mb-2">Posizione Sensori</h6>
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full border-2 border-red-500 flex items-center justify-center me-3 relative">
                                            <div class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></div>
                                        </div>
                                        <span class="text-slate-400 text-sm">Rosso/Giallo (Centro)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-slate-800/50 rounded-xl p-6 mt-8">
        <h5 class="text-white font-medium mb-4"><i class="bi bi-question-circle text-indigo-400 me-2"></i>Linee Guida</h5>
        <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-400">
            <ul class="space-y-2">
                <li class="flex items-start"><i class="bi bi-check-circle text-green-500 me-2"></i> Buona illuminazione</li>
                <li class="flex items-start"><i class="bi bi-check-circle text-green-500 me-2"></i> Posizione naturale</li>
            </ul>
            <ul class="space-y-2">
                <li class="flex items-start"><i class="bi bi-x-circle text-red-500 me-2"></i> No immagini sfocate</li>
                <li class="flex items-start"><i class="bi bi-x-circle text-red-500 me-2"></i> No ostacoli sui sensori</li>
            </ul>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-[#0f1021]">
            <div class="modal-header border-b border-[#2e3054] py-3">
                <h5 class="modal-title text-white text-lg" id="imageModalLabel">
                    <i class="bi bi-zoom-in me-2"></i>Anteprima Dettagliata
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body p-0 flex items-center justify-center bg-black relative">
                <div class="image-container relative">
                    <img id="modalImage" src="" alt="Zoom" class="img-fluid" style="max-height: 80vh;">
                </div>

                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 bg-white/10 backdrop-blur-md rounded-full p-2 border border-white/20">
                    <button type="button" class="btn btn-outline-light rounded-circle" id="zoomOut"><i class="bi bi-dash-lg"></i></button>
                    <button type="button" class="btn btn-outline-light rounded-circle" id="zoomReset"><i class="bi bi-arrow-clockwise"></i></button>
                    <button type="button" class="btn btn-outline-light rounded-circle" id="zoomIn"><i class="bi bi-plus-lg"></i></button>
                </div>
            </div>
            <div class="modal-footer bg-[#0f1021] border-t border-[#2e3054]">
                 <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
    /* Stili specifici per il drag & drop */
    .file-upload-area.dragover {
        border-color: #6366f1 !important;
        background-color: rgba(99, 102, 241, 0.1) !important;
    }

    /* Mapping classi custom usate nel JS originale a utility Tailwind/CSS */
    .border-info { border-color: #0ea5e9 !important; }
    .border-success { border-color: #22c55e !important; }
    .text-success { color: #22c55e !important; }
    .text-info { color: #0ea5e9 !important; }
    .text-primary { color: #6366f1 !important; }
</style>

<script>
    console.log('ðŸš€ Inizializzazione upload.html - Kin.ai Theme');

    // Funzione per rimuovere lo sfondo (ORIGINALE)
    async function removeImageBackground(imageBase64) {
        console.log('ðŸ”„ Invio richiesta rimozione sfondo...');

        updateProcessingStatus('Rimozione sfondo in corso...', 'Elaborazione con AI...', 30);

        try {
            const response = await fetch('/api/remove_background', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_base64: imageBase64,
                    use_preprocess: true,
                    resize_max: 1024,
                    grabcut_if_failed: true
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                console.log('âœ… Sfondo rimosso con successo usando:', result.method);
                updateProcessingStatus('Sfondo rimosso!', `Metodo: ${result.method}`, 60);
                return result.image_base64;
            } else {
                console.error('âŒ Errore rimozione sfondo:', result.error);
                showWarning('âš ï¸ Impossibile rimuovere lo sfondo, uso immagine originale');
                return imageBase64;
            }
        } catch (error) {
            console.error('âŒ Errore durante la rimozione dello sfondo:', error);
            showWarning('âš ï¸ Errore nella rimozione sfondo, uso immagine originale');
            return imageBase64;
        }
    }

    function updateProcessingStatus(title, message, progress) {
        const statusDiv = document.getElementById('processingStatus');
        const titleEl = document.getElementById('processingTitle');
        const messageEl = document.getElementById('processingMessage');
        const progressBar = document.getElementById('processingProgress');

        if (statusDiv && titleEl && messageEl && progressBar) {
            statusDiv.classList.remove('d-none'); // Compatibility class
            statusDiv.style.display = 'block';
            titleEl.textContent = title;
            messageEl.textContent = message;
            progressBar.style.width = progress + '%';
        }
    }

    function hideProcessingStatus() {
        const statusDiv = document.getElementById('processingStatus');
        if (statusDiv) {
            statusDiv.classList.add('d-none');
            statusDiv.style.display = 'none';
        }
    }

    // Global variables
    let imageModalInstance = null;
    let currentScale = 1;
    const minScale = 0.5;
    const maxScale = 5;
    const scaleStep = 0.25;

    // Initialization
    document.addEventListener('DOMContentLoaded', function () {
        console.log('âœ… DOM loaded');
        initializeUploadForm();
        initializeImageModal();
    });

    function initializeUploadForm() {
        const uploadForm = document.getElementById('uploadForm');
        const fileUploadArea = document.querySelector('.file-upload-area');
        const fileInput = document.getElementById('referenceImage');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        // Touch handling for upload area
        if (fileUploadArea) {
            fileUploadArea.addEventListener('touchstart', function (e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('touchend', function (e) {
                e.preventDefault();
                this.classList.remove('dragover');
                fileInput.click();
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, unhighlight, false);
            });

            fileUploadArea.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            fileUploadArea.classList.add('dragover');
        }

        function unhighlight() {
            fileUploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFiles(files);
        }

        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                handleFiles(this.files);
            });
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileName.textContent = `File selezionato: ${file.name} (${fileSize} MB)`;
                fileInfo.classList.remove('d-none');
                fileInfo.style.display = 'block';

                const limbType = document.querySelector('input[name="limb_type"]').value;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewDiv = document.getElementById('referencePreview');
                    const previewImg = document.getElementById('previewImage');

                    if (previewDiv && previewImg) {
                        previewImg.src = e.target.result;
                        previewDiv.classList.remove('d-none');
                        previewDiv.style.display = 'block';

                        updateImageInfo(file, limbType, "Gamba");

                        const previewCard = previewDiv.querySelector('.card'); // Note: .card doesn't exist in tailwind structure but logic is fine
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        if (uploadForm) {
            uploadForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const uploadBtn = document.getElementById('uploadBtn');
                const uploadSpinner = document.getElementById('uploadSpinner');
                const removeBackgroundCheckbox = document.getElementById('removeBackground');

                if (!fileInput.files || fileInput.files.length === 0) {
                    showError('âŒ Seleziona un\'immagine prima di caricare');
                    return;
                }

                try {
                    localStorage.removeItem('cleanReferenceImage');
                    localStorage.removeItem('validationOverlayImage');
                    localStorage.removeItem('referenceImage');
                    localStorage.removeItem('referenceMetadata');
                    console.log('ðŸ—‘ï¸ Dati di riferimento precedenti rimossi dal localStorage');
                } catch (error) {
                    console.error('Errore pulizia localStorage:', error);
                }

                uploadBtn.disabled = true;
                uploadSpinner.classList.remove('d-none');
                updateProcessingStatus('Preparazione...', 'Lettura file...', 10);

                try {
                    const file = fileInput.files[0];
                    let imageBase64 = await fileToBase64(file);

                    let imageBase64_processed = imageBase64;

                    if (removeBackgroundCheckbox.checked) {
                        imageBase64_processed = await removeImageBackground(imageBase64);
                    } else {
                        updateProcessingStatus('Preparazione completata', 'Sfondo non rimosso', 60);
                        showWarning('Attenzione: la rimozione sfondo Ã¨ disabilitata.');
                    }

                    const previewImg = document.getElementById('previewImage');
                    if (previewImg) {
                        previewImg.src = imageBase64_processed;
                    }

                    updateProcessingStatus('Caricamento e Analisi...', 'Invio al server...', 70);

                    const formData = new FormData();
                    const blob = await base64ToBlob(imageBase64_processed);
                    formData.append('file', blob, file.name);
                    formData.append('session_id', 'default');

                    const response = await fetch('/api/upload_reference', {
                        method: 'POST',
                        body: formData
                    });

                    const uploadResult = await response.json();

                    if (!response.ok || !uploadResult.success) {
                        const errorMsg = uploadResult.error || `HTTP error! status: ${response.status}`;
                        throw new Error(errorMsg);
                    }

                    updateProcessingStatus('Salvataggio locale...', 'Quasi fatto...', 90);

                    try {
                        const cleanReferenceBase64 = uploadResult.reference_image.startsWith('data:')
                            ? uploadResult.reference_image
                            : `data:image/png;base64,${uploadResult.reference_image}`;

                        const overlayBase64 = uploadResult.drawing_overlay_image.startsWith('data:')
                            ? uploadResult.drawing_overlay_image
                            : `data:image/png;base64,${uploadResult.drawing_overlay_image}`;

                        localStorage.setItem('cleanReferenceImage', cleanReferenceBase64);
                        localStorage.setItem('validationOverlayImage', overlayBase64);

                        const metadata = {
                            fileName: file.name,
                            uploadDate: new Date().toISOString(),
                            session_id: uploadResult.session_id,
                            sensorsFound: uploadResult.sensors_found,
                            backgroundRemoved: removeBackgroundCheckbox.checked,
                            sensors_data: uploadResult.sensors_data
                        };
                        localStorage.setItem('referenceMetadata', JSON.stringify(metadata));

                    } catch (error) {
                         if (error.name === 'QuotaExceededError') {
                            showError('Immagine troppo grande per il localStorage.');
                        } else {
                            console.error('âŒ Errore salvataggio localStorage:', error);
                        }
                        hideProcessingStatus();
                        return;
                    }

                    updateProcessingStatus('Completato!', 'Tutto pronto', 100);

                    displayDetectionResults(uploadResult);

                    const previewDiv = document.getElementById('referencePreview');
                    showSuccess('âœ… Immagine caricata con successo!');

                    previewDiv.scrollIntoView({behavior: 'smooth', block: 'start'});

                    setTimeout(hideProcessingStatus, 2000);

                } catch (error) {
                    console.error('âŒ Errore durante il processo:', error);
                    showError('âŒ Errore: ' + error.message);
                    hideProcessingStatus();
                } finally {
                    uploadBtn.disabled = false;
                    uploadSpinner.classList.add('d-none');
                }
            });
        }

        window.clearAllReferenceData = function (showConfirm = true) {
            const doClear = () => {
                try {
                    localStorage.removeItem('cleanReferenceImage');
                    localStorage.removeItem('validationOverlayImage');
                    localStorage.removeItem('referenceImage');
                    localStorage.removeItem('referenceMetadata');
                } catch (error) {}

                const previewDiv = document.getElementById('referencePreview');
                if (previewDiv) previewDiv.classList.add('d-none');
                const detectionResultsDiv = document.getElementById('detectionResults');
                if (detectionResultsDiv) detectionResultsDiv.classList.add('d-none');
                const uploadForm = document.getElementById('uploadForm');
                if (uploadForm) uploadForm.reset();
                const fileInfo = document.getElementById('fileInfo');
                if (fileInfo) fileInfo.classList.add('d-none');

                hideProcessingStatus();

                if (showConfirm) {
                    showSuccess('ðŸ—‘ï¸ Dati cancellati!');
                }
            };

            if (showConfirm) {
                if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                    doClear();
                }
            } else {
                doClear();
            }
        };
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function base64ToBlob(base64Data) {
        if (base64Data.startsWith('data:')) {
            base64Data = base64Data.split(',')[1];
        }
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], {type: 'image/png'});
    }

    function updateImageInfo(file, limbType, viewType) {
        const previewInfo = document.getElementById('previewInfo');
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        let viewText = viewType || 'Sconosciuto';

        previewInfo.innerHTML = `
            <div class="col-md-4 col-6">
                <div class="p-3 bg-slate-800 rounded-lg">
                    <span class="block text-indigo-400 font-bold break-all">${file.name}</span>
                    <span class="text-xs text-slate-500">Nome File</span>
                </div>
            </div>
            <div class="col-md-4 col-6">
                <div class="p-3 bg-slate-800 rounded-lg">
                    <span class="block text-green-400 font-bold">${fileSize} MB</span>
                    <span class="text-xs text-slate-500">Dimensione</span>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="p-3 bg-slate-800 rounded-lg">
                    <span class="block text-cyan-400 font-bold">${viewText}</span>
                    <span class="text-xs text-slate-500">Vista</span>
                </div>
            </div>
        `;
    }

    function displayDetectionResults(result) {
        const detectionResultsDiv = document.getElementById('detectionResults');
        if (!detectionResultsDiv) return;

        detectionResultsDiv.classList.remove('d-none');
        detectionResultsDiv.style.display = 'block';

        const originalImg = document.getElementById('originalImage');
        const annotatedImg = document.getElementById('annotatedImage');

        if (originalImg && result.reference_image) {
            originalImg.src = result.reference_image.startsWith('data:')
                ? result.reference_image
                : `data:image/png;base64,${result.reference_image}`;
        }

        if (annotatedImg && result.annotated_image) {
            annotatedImg.src = result.annotated_image.startsWith('data:')
                ? result.annotated_image
                : `data:image/png;base64,${result.annotated_image}`;

            const annotatedTab = document.getElementById('annotated-tab');
            if (annotatedTab) {
                setTimeout(() => {
                    new bootstrap.Tab(annotatedTab).show();
                }, 500);
            }
        }

        if (originalImg) {
            originalImg.addEventListener('click', function () {
                openImageInModal(this.src);
            });
        }
        if (annotatedImg) {
            annotatedImg.addEventListener('click', function () {
                openImageInModal(this.src);
            });
        }

        detectionResultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openImageInModal(imageSrc) {
        const modalImage = document.getElementById('modalImage');
        if (modalImage && imageModalInstance) {
            modalImage.src = imageSrc;
            imageModalInstance.show();
            resetZoom();
        }
    }

    function initializeImageModal() {
        const previewImage = document.getElementById('previewImage');
        const modalElement = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        if (!modalElement) return;

        imageModalInstance = new bootstrap.Modal(modalElement);

        if (previewImage) {
            previewImage.addEventListener('click', function () {
                if (this.src && this.src !== '') {
                    modalImage.src = this.src;
                    imageModalInstance.show();
                    resetZoom();
                }
            });
        }

        setupZoomControls();

        // Touch zoom logic (unchanged)
        let initialDistance = 0;
        let currentDistance = 0;
        modalImage.addEventListener('touchstart', function (e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                initialDistance = getDistance(e.touches[0], e.touches[1]);
            }
        });
        modalImage.addEventListener('touchmove', function (e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                currentDistance = getDistance(e.touches[0], e.touches[1]);
                if (initialDistance > 0) {
                    const scale = currentDistance / initialDistance;
                    const newScale = Math.min(Math.max(currentScale * scale, minScale), maxScale);
                    applyZoom(newScale);
                    initialDistance = currentDistance;
                }
            }
        });
        modalImage.addEventListener('touchend', function (e) {
            if (e.touches.length < 2) { initialDistance = 0; }
        });

        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
    }

    function setupZoomControls() {
        const zoomIn = document.getElementById('zoomIn');
        const zoomOut = document.getElementById('zoomOut');
        const zoomReset = document.getElementById('zoomReset');
        if (zoomIn) zoomIn.addEventListener('click', () => zoom(scaleStep));
        if (zoomOut) zoomOut.addEventListener('click', () => zoom(-scaleStep));
        if (zoomReset) zoomReset.addEventListener('click', resetZoom);
    }

    function zoom(delta) {
        const newScale = Math.min(Math.max(currentScale + delta, minScale), maxScale);
        applyZoom(newScale);
    }

    function applyZoom(scale) {
        currentScale = scale;
        const modalImage = document.getElementById('modalImage');
        if (modalImage) {
            modalImage.style.transform = `scale(${currentScale})`;
            modalImage.style.transition = 'transform 0.2s ease';
        }
    }

    function resetZoom() {
        currentScale = 1;
        const modalImage = document.getElementById('modalImage');
        if (modalImage) {
            modalImage.style.transform = 'scale(1)';
        }
    }

    function showSuccess(message) { showNotification(message, 'success'); }
    function showError(message) { showNotification(message, 'danger'); }
    function showWarning(message) { showNotification(message, 'warning'); }

    function showNotification(message, type) {
        const uploadResult = document.getElementById('uploadResult');
        if (!uploadResult) return;

        // Custom notification style using Tailwind logic injected via HTML
        const colors = {
            'success': 'bg-green-900/50 border-green-500 text-green-200',
            'danger': 'bg-red-900/50 border-red-500 text-red-200',
            'warning': 'bg-yellow-900/50 border-yellow-500 text-yellow-200',
            'info': 'bg-blue-900/50 border-blue-500 text-blue-200'
        };
        const colorClass = colors[type] || colors['info'];

        const alertHTML = `
            <div class="alert alert-${type} ${colorClass} p-4 rounded-lg border flex items-center justify-between mb-3 fade show" role="alert">
                <div class="flex items-center">
                    <i class="bi bi-info-circle me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close opacity-50 hover:opacity-100" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        uploadResult.innerHTML = alertHTML;

        setTimeout(() => {
            const alert = uploadResult.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
</script>
{% endblock %}