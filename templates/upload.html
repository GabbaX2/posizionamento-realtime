{% extends "base.html" %}

{% block title %}Carica Riferimento - Sensor Placement Validator{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Carica Immagine di Riferimento</h1>
            <p class="text-slate-400">Carica una foto chiara dell'arto. Il sistema estrarr√† i contorni per la
                validazione.</p>
        </div>

        <div class="bg-[#161831] border border-[#2e3054] rounded-2xl shadow-xl overflow-hidden">
            <div class="p-1 bg-gradient-to-r from-indigo-500/20 to-cyan-500/20"></div>

            <div class="p-6 md:p-8">
                <form id="uploadForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" name="limb_type" value="leg">
                    <input type="hidden" name="view_type" value="anterior">

                    <div class="mb-8 p-4 bg-[#0f1021] rounded-xl border border-[#2e3054] flex items-center justify-between">
                        <div>
                            <h3 class="text-white font-medium flex items-center gap-2">
                                <i class="bi bi-magic text-indigo-400"></i> Analisi Sfondo
                            </h3>
                            <p class="text-sm text-slate-500 mt-1">Rimuovi sfondo per isolare meglio i contorni.</p>
                        </div>
                        <div class="form-check form-switch relative">
                            <input class="form-check-input h-6 w-11 rounded-full bg-slate-700 border-transparent cursor-pointer transition-colors ease-in-out duration-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                   type="checkbox" id="removeBackground" checked>
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-medium text-slate-300 mb-2">File Immagine</label>

                        <div class="file-upload-area relative border-2 border-dashed border-slate-600 bg-slate-800/30 hover:bg-slate-800/50 hover:border-indigo-500 rounded-xl p-10 text-center transition-all cursor-pointer group flex flex-col items-center justify-center min-h-[220px]">

                            <div class="space-y-4">
                                <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto group-hover:bg-indigo-500/20 transition-colors">
                                    <i class="bi bi-cloud-arrow-up text-3xl text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-medium text-white">Trascina qui l'immagine</h4>
                                    <p class="text-slate-500 text-sm mt-1">oppure</p>
                                </div>

                                <input class="d-none" type="file" id="referenceImage" name="file" accept="image/*"
                                       required>

                                <button type="button"
                                        class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-indigo-500/20"
                                        onclick="document.getElementById('referenceImage').click()">
                                    <i class="bi bi-folder2-open me-2"></i>Scegli File
                                </button>
                            </div>

                            <p class="text-xs text-slate-600 mt-6">JPG, PNG, WebP (Max 10MB)</p>
                        </div>

                        <div id="fileInfo" class="mt-4 hidden">
                            <div class="flex items-center gap-3 p-3 bg-indigo-900/20 border border-indigo-500/30 rounded-lg text-indigo-200 text-sm">
                                <i class="bi bi-info-circle flex-shrink-0"></i>
                                <span id="fileName"></span>
                            </div>
                        </div>
                    </div>

                    <div id="processingStatus" class="mb-6 hidden">
                        <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="spinner-border text-yellow-500 w-5 h-5" role="status">
                                    <span class="visually-hidden">...</span>
                                </div>
                                <div>
                                    <h6 class="text-yellow-200 font-medium text-sm" id="processingTitle">
                                        Elaborazione...</h6>
                                    <p class="text-yellow-400/70 text-xs" id="processingMessage">Attendere prego</p>
                                </div>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-yellow-500 h-1.5 rounded-full transition-all duration-300 progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%" id="processingProgress"></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit"
                            class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-900/50 transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            id="uploadBtn">
                        <i class="bi bi-cloud-upload me-2"></i>
                        <span class="upload-text">Carica e Analizza</span>
                        <div class="spinner-border spinner-border-sm ms-2 hidden" role="status"
                             id="uploadSpinner"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="uploadResult" class="mt-6"></div>

        <div class="text-center mt-6">
            <button type="button"
                    class="text-slate-400 hover:text-red-400 text-sm transition-colors flex items-center justify-center gap-2 mx-auto"
                    onclick="clearAllReferenceData()">
                <i class="bi bi-trash3"></i> Cancella Riferimento Salvato
            </button>
        </div>

        <div id="referencePreview" class="mt-12 hidden">
            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
                <div class="px-6 py-4 border-b border-[#2e3054] bg-[#0f1021]/50">
                    <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="bi bi-eye text-indigo-400"></i> Anteprima Selezione
                    </h4>
                </div>
                <div class="p-6">
                    <div class="flex flex-col items-center">
                        <img id="previewImage" src="" alt="Preview"
                             class="max-h-[50vh] rounded-lg shadow-2xl border border-slate-700 cursor-zoom-in transition-transform hover:scale-[1.01] preview-image">
                        <p class="text-slate-500 text-xs mt-3"><i class="bi bi-zoom-in"></i> Tocca per ingrandire</p>
                    </div>
                    <div id="previewInfo" class="row mt-6 text-center g-4"></div>
                </div>
            </div>
        </div>

        <div id="detectionResults" class="mt-8 hidden">
            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
                <div class="px-6 py-4 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border-b border-[#2e3054]">
                    <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="bi bi-cpu text-cyan-400"></i> Analisi Contorni (Edge-Based)
                    </h4>
                </div>

                <div class="p-6">
                    <ul class="nav nav-tabs flex border-b border-[#2e3054] mb-6" id="imageTabs" role="tablist">
                        <li class="nav-item mr-1" role="presentation">
                            <button class="nav-link active bg-transparent text-slate-400 hover:text-white border-transparent hover:border-indigo-500 px-4 py-2 font-medium transition-all"
                                    id="original-tab" data-bs-toggle="tab" data-bs-target="#original-pane" type="button"
                                    role="tab">
                                <i class="bi bi-image me-1"></i>Reale
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link bg-transparent text-slate-400 hover:text-white border-transparent hover:border-indigo-500 px-4 py-2 font-medium transition-all"
                                    id="annotated-tab" data-bs-toggle="tab" data-bs-target="#annotated-pane"
                                    type="button" role="tab">
                                <i class="bi bi-vector-pen me-1"></i>Maschera Bordi (AI)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="imageTabsContent">
                        <div class="tab-pane fade show active" id="original-pane" role="tabpanel">
                            <div class="relative group cursor-zoom-in rounded-xl overflow-hidden bg-black/50 border border-slate-700/50">
                                <img id="originalImage" src="" alt="Originale"
                                     class="img-fluid mx-auto max-h-[60vh] object-contain">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center pointer-events-none">
                                <span class="bg-black/70 text-white px-3 py-1 rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="bi bi-zoom-in"></i> Clicca per ingrandire
                                </span>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="annotated-pane" role="tabpanel">
                            <div class="relative group cursor-zoom-in rounded-xl overflow-hidden bg-black border border-indigo-500/30">
                                <img id="annotatedImage" src="" alt="Maschera Bordi"
                                     class="img-fluid mx-auto max-h-[60vh] object-contain opacity-90">

                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center pointer-events-none">
                                <span class="bg-indigo-600/90 text-white px-3 py-1 rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                                    <i class="bi bi-zoom-in"></i> Analizza Maschera
                                </span>
                                </div>
                            </div>

                            <div class="bg-[#0f1021] rounded-xl p-6 border border-[#2e3054] mt-6">
                                <h5 class="text-white font-medium mb-4 flex items-center gap-2">
                                    <i class="bi bi-info-circle-fill text-indigo-500"></i> Logica di Validazione
                                </h5>
                                <p class="text-slate-400 text-sm mb-4">
                                    L'algoritmo non usa i colori del pavimento/muro. Invece, estrae i bordi dalla webcam
                                    e li confronta con le linee bianche della maschera qui sopra.
                                </p>
                                <div class="flex items-center gap-4 text-xs font-mono">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-white border border-slate-600"></span>
                                        <span class="text-slate-300">Target Allineamento</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-black border border-slate-600"></span>
                                        <span class="text-slate-300">Ignorato</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen m-0 p-0">
            <div class="modal-content bg-black/95 backdrop-blur-md border-0 h-full w-full">

                <div class="absolute top-0 left-0 w-full z-50 p-4 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                    <h5 class="text-white/90 text-lg font-light flex items-center gap-2 pointer-events-auto">
                        <i class="bi bi-aspect-ratio"></i> Ispettore Dettagli
                    </h5>
                    <button type="button"
                            class="pointer-events-auto text-white/70 hover:text-white text-2xl p-2 transition-transform hover:rotate-90"
                            data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="modal-body p-0 flex items-center justify-center w-full h-full overflow-hidden relative">
                    <img id="modalImage" src="" alt="Zoom"
                         class="max-w-[95vw] max-h-[90vh] object-contain transition-transform duration-200 cursor-move">
                </div>

                <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-50">
                    <div class="flex items-center gap-4 bg-[#161831]/90 border border-[#2e3054] p-3 rounded-full shadow-[0_0_20px_rgba(0,0,0,0.5)] backdrop-blur-xl">
                        <button type="button" id="zoomOut"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700/50 hover:bg-indigo-600 text-white transition-all active:scale-90">
                            <i class="bi bi-dash-lg text-lg"></i>
                        </button>

                        <span id="zoomLevelDisplay"
                              class="text-xs font-mono text-indigo-300 min-w-[40px] text-center select-none">100%</span>

                        <button type="button" id="zoomReset"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700/50 hover:bg-indigo-600 text-white transition-all active:scale-90"
                                title="Resetta">
                            <i class="bi bi-arrow-clockwise text-lg"></i>
                        </button>

                        <button type="button" id="zoomIn"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700/50 hover:bg-indigo-600 text-white transition-all active:scale-90">
                            <i class="bi bi-plus-lg text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <style>
        .file-upload-area.dragover {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.1) !important;
        }

        .hidden {
            display: none !important;
        }

        /* Utilit√† per toggle */
    </style>

    <script>
        console.log('üöÄ Inizializzazione upload.html - Edge-Based Mode');

        // --- UTILITY RIMUOVI SFONDO (Invariata ma sempre utile per l'anteprima) ---
        async function removeImageBackground(imageBase64) {
            updateProcessingStatus('Rimozione sfondo...', 'AI Processing...', 30);
            try {
                const response = await fetch('/api/remove_background', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image_base64: imageBase64})
                });
                const result = await response.json();
                if (result.success) {
                    updateProcessingStatus('Sfondo rimosso!', `Metodo: ${result.method}`, 60);
                    return result.image_base64;
                } else {
                    showWarning('‚ö†Ô∏è Fallback su immagine originale');
                    return imageBase64;
                }
            } catch (error) {
                console.error('‚ùå Errore background:', error);
                return imageBase64;
            }
        }

        // --- STATUS HELPERS ---
        function updateProcessingStatus(title, message, progress) {
            const statusDiv = document.getElementById('processingStatus');
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                document.getElementById('processingTitle').textContent = title;
                document.getElementById('processingMessage').textContent = message;
                document.getElementById('processingProgress').style.width = progress + '%';
            }
        }

        function hideProcessingStatus() {
            const s = document.getElementById('processingStatus');
            if (s) s.classList.add('hidden');
        }

        // --- VARIABLES ---
        let imageModalInstance = null;
        let currentScale = 1;
        const minScale = 0.5, maxScale = 5, scaleStep = 0.25;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', function () {
            initializeUploadForm();
            initializeImageModal();
        });

        // --- UPLOAD FORM LOGIC ---
        function initializeUploadForm() {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('referenceImage');
            const fileUploadArea = document.querySelector('.file-upload-area');

            // Drag & Drop UI events
            if (fileUploadArea) {
                ['dragenter', 'dragover'].forEach(e => fileUploadArea.addEventListener(e, (ev) => {
                    ev.preventDefault();
                    fileUploadArea.classList.add('dragover');
                }));
                ['dragleave', 'drop'].forEach(e => fileUploadArea.addEventListener(e, (ev) => {
                    ev.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                }));
                fileUploadArea.addEventListener('drop', (e) => {
                    fileInput.files = e.dataTransfer.files;
                    handleFiles(fileInput.files);
                });
            }

            if (fileInput) fileInput.onchange = () => handleFiles(fileInput.files);

            // File Handler
            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    document.getElementById('fileName').textContent = `${file.name}`;
                    document.getElementById('fileInfo').classList.remove('hidden');

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('previewImage');
                        if (img) img.src = e.target.result;
                        document.getElementById('referencePreview').classList.remove('hidden');
                        updateImageInfo(file);
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Submit Handler
            if (uploadForm) {
                uploadForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('uploadBtn');
                    const spinner = document.getElementById('uploadSpinner');
                    const removeBgCheck = document.getElementById('removeBackground');

                    if (!fileInput.files.length) return showError('Seleziona un file!');

                    btn.disabled = true;
                    spinner.classList.remove('hidden');
                    updateProcessingStatus('Avvio...', 'Lettura file...', 10);

                    try {
                        // 1. Preparazione File
                        const file = fileInput.files[0];
                        let base64Img = await fileToBase64(file);

                        // 2. Pre-processing Opzionale (Solo visivo per anteprima immediata)
                        // Nota: Il vero lavoro lo fa il backend nell'API upload_reference
                        if (removeBgCheck.checked) {
                            base64Img = await removeImageBackground(base64Img);
                        }

                        document.getElementById('previewImage').src = base64Img;

                        // 3. Upload al Server
                        updateProcessingStatus('Analisi...', 'Invio al server...', 70);
                        const formData = new FormData();
                        formData.append('file', file); // Inviamo il file originale, il backend lo ri-processa meglio
                        formData.append('session_id', 'default');

                        const res = await fetch('/api/upload_reference', {method: 'POST', body: formData});
                        const result = await res.json();

                        if (!result.success) throw new Error(result.error);

                        updateProcessingStatus('Salvataggio...', 'Configurazione...', 90);

                        // 4. Salvataggio LocalStorage
                        const cleanRef = fixBase64(result.reference_image);
                        const overlayRef = fixBase64(result.drawing_overlay_image);

                        localStorage.setItem('cleanReferenceImage', cleanRef);
                        localStorage.setItem('validationOverlayImage', overlayRef);
                        localStorage.setItem('referenceMetadata', JSON.stringify({
                            session_id: result.session_id,
                            steps_config: result.steps_config
                        }));

                        // 5. Visualizzazione Risultati
                        updateProcessingStatus('Fatto!', 'Analisi Completata', 100);
                        showSuccess('Analisi completata con successo!');

                        displayDetectionResults(result);

                        setTimeout(hideProcessingStatus, 1500);

                    } catch (err) {
                        showError(err.message);
                        hideProcessingStatus();
                    } finally {
                        btn.disabled = false;
                        spinner.classList.add('hidden');
                    }
                };
            }
        }

        // --- RESULTS DISPLAY LOGIC (FIXED) ---
        function displayDetectionResults(result) {
            const container = document.getElementById('detectionResults');
            if (!container) return;

            container.classList.remove('hidden');

            const originalImg = document.getElementById('originalImage');
            const annotatedImg = document.getElementById('annotatedImage');

            // Tab 1: Immagine Reale Pulita
            if (originalImg && result.reference_image) {
                originalImg.src = fixBase64(result.reference_image);
            }

            // Tab 2: Maschera Bordi (Fondamentale per la validazione Edge-Based)
            // Usiamo drawing_overlay_image se disponibile (nuovo backend), fallback su annotated (vecchio)
            const maskSrc = result.drawing_overlay_image || result.annotated_image;
            if (annotatedImg && maskSrc) {
                annotatedImg.src = fixBase64(maskSrc);
            }

            // Binding Click Modale
            if (originalImg) originalImg.onclick = () => openImageInModal(originalImg.src);
            if (annotatedImg) annotatedImg.onclick = () => openImageInModal(annotatedImg.src);

            container.scrollIntoView({behavior: 'smooth'});
        }

        // --- MODAL LOGIC (FIXED) ---
        function initializeImageModal() {
            const modalEl = document.getElementById('imageModal');
            if (!modalEl) return;

            imageModalInstance = new bootstrap.Modal(modalEl);

            // Zoom bindings
            document.getElementById('zoomIn').onclick = () => zoom(scaleStep);
            document.getElementById('zoomOut').onclick = () => zoom(-scaleStep);
            document.getElementById('zoomReset').onclick = resetZoom;

            // Click Anteprima Header
            const headerPreview = document.getElementById('previewImage');
            if (headerPreview) headerPreview.onclick = () => openImageInModal(headerPreview.src);
        }

        function openImageInModal(src) {
            // SAFETY CHECK: Non aprire se src √® vuoto o invalido
            if (!src || src.length < 50 || src.includes('window.location')) return;

            const img = document.getElementById('modalImage');
            if (img) {
                img.src = src;
                imageModalInstance.show();
                resetZoom();
            }
        }

        function zoom(delta) {
            currentScale = Math.min(Math.max(currentScale + delta, minScale), maxScale);
            updateZoomUI();
        }

        function resetZoom() {
            currentScale = 1;
            updateZoomUI();
        }

        function updateZoomUI() {
            const img = document.getElementById('modalImage');
            const lbl = document.getElementById('zoomLevelDisplay');
            if (img) img.style.transform = `scale(${currentScale})`;
            if (lbl) lbl.innerText = Math.round(currentScale * 100) + '%';
        }

        // --- HELPERS ---
        function fixBase64(str) {
            return str.startsWith('data:') ? str : `data:image/png;base64,${str}`;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.onerror = reject;
                r.readAsDataURL(file);
            });
        }

        function updateImageInfo(file) {
            const info = document.getElementById('previewInfo');
            info.innerHTML = `
            <div class="col-6"><div class="p-2 bg-slate-800 rounded text-indigo-300 font-mono text-xs">${file.name}</div></div>
            <div class="col-6"><div class="p-2 bg-slate-800 rounded text-green-300 font-mono text-xs">${(file.size / 1024 / 1024).toFixed(2)} MB</div></div>
        `;
        }

        function showSuccess(msg) {
            showNotification(msg, 'success');
        }

        function showError(msg) {
            showNotification(msg, 'danger');
        }

        function showWarning(msg) {
            showNotification(msg, 'warning');
        }

        function showNotification(msg, type) {
            const container = document.getElementById('uploadResult');
            const colors = {
                'success': 'bg-green-900/80 border-green-500 text-green-100',
                'danger': 'bg-red-900/80 border-red-500 text-red-100',
                'warning': 'bg-yellow-900/80 border-yellow-500 text-yellow-100'
            };
            const cls = colors[type];

            container.innerHTML = `
            <div class="alert ${cls} p-4 rounded-lg border flex justify-between items-center shadow-lg">
                <span>${msg}</span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        `;
        }

        // Global clear function
        window.clearAllReferenceData = function () {
            if (!confirm('Cancellare tutto?')) return;
            localStorage.clear();
            location.reload();
        };
    </script>
{% endblock %}