{% extends "base.html" %}

{% block title %}Carica Riferimento - Sensor Placement Validator{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto pb-20">
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Carica Immagine di Riferimento</h1>
            <p class="text-slate-400">Carica una foto chiara dell'arto. Il sistema estrarr√† i contorni per la
                validazione.</p>
        </div>

        <div class="bg-[#161831] border border-[#2e3054] rounded-2xl shadow-xl overflow-hidden relative z-10">
            <div class="p-1 bg-gradient-to-r from-indigo-500/20 to-cyan-500/20"></div>

            <div class="p-6 md:p-8">
                <form id="uploadForm" enctype="multipart/form-data" novalidate>

                    <div class="mb-8 p-4 bg-[#0f1021] rounded-xl border border-[#2e3054] flex items-center justify-between">
                        <div>
                            <h3 class="text-white font-medium flex items-center gap-2">
                                <i class="bi bi-magic text-indigo-400"></i> Analisi Sfondo
                            </h3>
                            <p class="text-sm text-slate-500 mt-1">Rimuovi sfondo per isolare meglio i contorni.</p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="removeBackground" id="removeBackground"
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-6 checked:bg-indigo-500 transition-all duration-300"
                                   checked/>
                            <label for="removeBackground"
                                   class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer"></label>
                        </div>
                    </div>

                    <div class="mb-8 space-y-4">
                        <label class="block text-sm font-medium text-slate-300">File Immagine</label>

                        <div class="file-upload-area relative border-2 border-dashed border-slate-600 bg-slate-800/30 hover:bg-slate-800/50 hover:border-indigo-500 rounded-xl p-10 text-center transition-all cursor-pointer group flex flex-col items-center justify-center min-h-[220px]">

                            <div class="space-y-4 pointer-events-none">
                                <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto group-hover:bg-indigo-500/20 transition-colors">
                                    <i class="bi bi-cloud-arrow-up text-3xl text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-medium text-white">Trascina qui l'immagine</h4>
                                    <p class="text-slate-500 text-sm mt-1">oppure clicca per selezionare</p>
                                </div>
                            </div>

                            <input class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" type="file"
                                   id="referenceImage" name="file" accept="image/*" required>
                        </div>

                        <div id="fileInfo" class="hidden animate-fade-in">
                            <div class="flex items-center justify-between p-3 bg-indigo-900/20 border border-indigo-500/30 rounded-lg text-indigo-200 text-sm">
                                <div class="flex items-center gap-3">
                                    <i class="bi bi-file-earmark-image text-xl"></i>
                                    <span id="fileName" class="font-mono truncate max-w-[200px] md:max-w-md">filename.jpg</span>
                                </div>
                                <i class="bi bi-check-circle-fill text-green-400"></i>
                            </div>
                        </div>
                    </div>

                    <div id="processingStatus" class="mb-6 hidden">
                        <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="spinner-border text-yellow-500 w-4 h-4 border-2 rounded-full border-t-transparent animate-spin"></div>
                                    <h6 class="text-yellow-200 font-medium text-sm" id="processingTitle">
                                        Elaborazione...</h6>
                                </div>
                                <span class="text-yellow-400/70 text-xs font-mono" id="processingMessage">Init...</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-yellow-500 h-1.5 rounded-full transition-all duration-300"
                                     style="width: 0%" id="processingProgress"></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit"
                            class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-900/50 transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group"
                            id="uploadBtn">
                        <i class="bi bi-cloud-upload text-xl group-hover:translate-y-[-2px] transition-transform"></i>
                        <span>Carica e Analizza</span>
                        <div id="uploadSpinner"
                             class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="uploadResult" class="mt-6 space-y-3"></div>

        <div class="text-center mt-8">
            <button type="button"
                    class="text-slate-500 hover:text-red-400 text-sm transition-colors flex items-center justify-center gap-2 mx-auto px-4 py-2 rounded-lg hover:bg-red-500/10"
                    onclick="clearAllReferenceData()">
                <i class="bi bi-trash3"></i> Reset Sessione
            </button>
        </div>

        <div id="referencePreview" class="mt-12 hidden animate-fade-in-up">
            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
                <div class="px-6 py-4 border-b border-[#2e3054] bg-[#0f1021]/50">
                    <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="bi bi-eye text-indigo-400"></i> Anteprima Selezione
                    </h4>
                </div>
                <div class="p-6">
                    <div class="flex flex-col items-center gap-4">
                        <img id="previewImage" src="" alt="Preview"
                             class="max-h-[400px] w-auto rounded-lg shadow-2xl border border-slate-700 cursor-zoom-in transition-transform hover:scale-[1.01]">

                        <div id="previewInfo" class="w-full grid grid-cols-2 md:grid-cols-3 gap-4 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="detectionResults" class="mt-8 hidden animate-fade-in-up">
            <div class="bg-[#161831] border border-[#2e3054] rounded-2xl overflow-hidden shadow-lg">
                <div class="px-6 py-4 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border-b border-[#2e3054]">
                    <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="bi bi-cpu text-cyan-400"></i> Risultato Analisi
                    </h4>
                </div>

                <div class="p-6">
                    <ul class="nav nav-tabs flex border-b border-[#2e3054] mb-6 gap-2" id="imageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active bg-transparent text-slate-400 hover:text-white border border-transparent hover:border-indigo-500/50 rounded-t-lg px-4 py-2 font-medium transition-all"
                                    id="original-tab" data-bs-toggle="tab" data-bs-target="#original-pane" type="button"
                                    role="tab">
                                Reale
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link bg-transparent text-slate-400 hover:text-white border border-transparent hover:border-indigo-500/50 rounded-t-lg px-4 py-2 font-medium transition-all"
                                    id="annotated-tab" data-bs-toggle="tab" data-bs-target="#annotated-pane"
                                    type="button" role="tab">
                                Maschera Bordi
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="imageTabsContent">
                        <div class="tab-pane fade show active" id="original-pane" role="tabpanel">
                            <div class="relative group cursor-zoom-in rounded-xl overflow-hidden bg-black/50 border border-slate-700/50 flex justify-center">
                                <img id="originalImage" src="" alt="Originale"
                                     class="max-h-[500px] w-auto object-contain">
                            </div>
                        </div>

                        <div class="tab-pane fade" id="annotated-pane" role="tabpanel">
                            <div class="relative group cursor-zoom-in rounded-xl overflow-hidden bg-black border border-indigo-500/30 flex justify-center">
                                <img id="annotatedImage" src="" alt="Maschera"
                                     class="max-h-[500px] w-auto object-contain opacity-90">
                            </div>
                            <div class="bg-[#0f1021] rounded-xl p-4 border border-[#2e3054] mt-4 flex items-center gap-3">
                                <i class="bi bi-info-circle text-indigo-400 text-xl"></i>
                                <p class="text-slate-400 text-sm">
                                    Questa maschera (bianco su nero) verr√† usata per confrontare i bordi estratti dalla
                                    webcam in tempo reale.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen m-0 p-0">
            <div class="modal-content bg-black/95 backdrop-blur-md border-0 w-full h-full relative">

                <button type="button"
                        class="absolute top-6 right-6 z-[60] text-white/70 hover:text-white bg-black/20 hover:bg-white/10 rounded-full p-2 transition-all"
                        data-bs-dismiss="modal">
                    <i class="bi bi-x-lg text-2xl"></i>
                </button>

                <div class="w-full h-full flex items-center justify-center overflow-hidden p-4">
                    <img id="modalImage" src="" alt="Zoom"
                         class="max-w-full max-h-full object-contain transition-transform duration-200 cursor-move">
                </div>

                <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[60]">
                    <div class="flex items-center gap-4 bg-[#161831]/90 border border-[#2e3054] px-6 py-3 rounded-full shadow-2xl backdrop-blur-xl">
                        <button id="zoomOut" class="text-white hover:text-indigo-400 transition-colors"><i
                                class="bi bi-dash-lg text-xl"></i></button>
                        <span id="zoomLevelDisplay"
                              class="text-xs font-mono text-indigo-300 w-12 text-center select-none">100%</span>
                        <button id="zoomReset" class="text-white hover:text-indigo-400 transition-colors"><i
                                class="bi bi-arrow-clockwise text-xl"></i></button>
                        <button id="zoomIn" class="text-white hover:text-indigo-400 transition-colors"><i
                                class="bi bi-plus-lg text-xl"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <style>
        /* Utility Custom */
        .file-upload-area.dragover {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
        }

        /* Toggle Checkbox CSS Custom */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }

        .toggle-checkbox:checked + .toggle-label {
            background-color: #6366f1;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>

    <script>
        console.log('üöÄ Upload Page Init');

        // --- VARIABILI ---
        let imageModalInstance = null;
        let currentScale = 1;
        const minScale = 0.5, maxScale = 5, scaleStep = 0.25;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            setupForm();
            setupModal();
        });

        // --- FORM LOGIC ---
        function setupForm() {
            const fileInput = document.getElementById('referenceImage');
            const uploadForm = document.getElementById('uploadForm');

            // File Selection Listener
            fileInput.onchange = () => {
                if (fileInput.files.length) handleFile(fileInput.files[0]);
            };

            // Form Submit
            if (uploadForm) {
                uploadForm.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!fileInput.files.length) return showError("Seleziona un'immagine!");

                    setLoading(true);
                    try {
                        const file = fileInput.files[0];
                        let base64 = await toBase64(file);

                        // Pre-rimozione sfondo (opzionale, solo per coerenza visiva)
                        if (document.getElementById('removeBackground').checked) {
                            updateStatus("Rimozione Sfondo...", "AI Processing", 30);
                            base64 = await removeBgApi(base64);
                        }

                        // Upload
                        updateStatus("Invio...", "Upload al server", 60);
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('session_id', 'default');

                        const res = await fetch('/api/upload_reference', {method: 'POST', body: formData});
                        const data = await res.json();

                        if (!data.success) throw new Error(data.error);

                        // Save
                        updateStatus("Salvataggio...", "Configurazione locale", 90);
                        saveSessionData(data);

                        // Show Results
                        updateStatus("Fatto!", "Completato", 100);
                        showSuccess("Immagine caricata correttamente!");
                        displayResults(data);

                        setTimeout(() => document.getElementById('processingStatus').classList.add('hidden'), 1500);

                    } catch (err) {
                        showError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
            }
        }

        function handleFile(file) {
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');

            // Show immediate preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                document.getElementById('referencePreview').classList.remove('hidden');

                // GENERATE GRID INFO (FIXED LAYOUT)
                const infoDiv = document.getElementById('previewInfo');
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                infoDiv.innerHTML = `
                <div class="bg-slate-800 p-3 rounded-lg text-center">
                    <span class="block text-xs text-slate-500 uppercase">Nome</span>
                    <span class="text-sm text-indigo-300 font-mono truncate block">${file.name}</span>
                </div>
                <div class="bg-slate-800 p-3 rounded-lg text-center">
                    <span class="block text-xs text-slate-500 uppercase">Size</span>
                    <span class="text-sm text-green-300 font-mono">${sizeMB} MB</span>
                </div>
                <div class="bg-slate-800 p-3 rounded-lg text-center">
                    <span class="block text-xs text-slate-500 uppercase">Tipo</span>
                    <span class="text-sm text-cyan-300 font-mono">${file.type.split('/')[1] || 'img'}</span>
                </div>
            `;
            };
            reader.readAsDataURL(file);
        }

        // --- API & DATA ---
        async function removeBgApi(b64) {
            try {
                const res = await fetch('/api/remove_background', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image_base64: b64})
                });
                const d = await res.json();
                return d.success ? d.image_base64 : b64;
            } catch {
                return b64;
            }
        }

        function saveSessionData(data) {
            localStorage.setItem('cleanReferenceImage', fixB64(data.reference_image));
            localStorage.setItem('validationOverlayImage', fixB64(data.drawing_overlay_image));
            localStorage.setItem('referenceMetadata', JSON.stringify({
                session_id: data.session_id,
                steps_config: data.steps_config
            }));
        }

        function displayResults(data) {
            const div = document.getElementById('detectionResults');
            div.classList.remove('hidden');

            const imgReal = document.getElementById('originalImage');
            const imgMask = document.getElementById('annotatedImage');

            if (imgReal) imgReal.src = fixB64(data.reference_image);
            // Usa la nuova chiave drawing_overlay_image
            if (imgMask) imgMask.src = fixB64(data.drawing_overlay_image || data.annotated_image);

            // Bind clicks for modal
            [imgReal, imgMask].forEach(img => {
                if (img) img.onclick = () => openModal(img.src);
            });

            div.scrollIntoView({behavior: 'smooth'});
        }

        // --- MODAL ---
        function setupModal() {
            const el = document.getElementById('imageModal');
            if (el) imageModalInstance = new bootstrap.Modal(el);

            document.getElementById('zoomIn').onclick = () => zoom(scaleStep);
            document.getElementById('zoomOut').onclick = () => zoom(-scaleStep);
            document.getElementById('zoomReset').onclick = () => {
                currentScale = 1;
                updateZoom();
            };

            // Link preview click
            const preview = document.getElementById('previewImage');
            if (preview) preview.onclick = () => openModal(preview.src);
        }

        function openModal(src) {
            if (!src || src.length < 50) return;
            const img = document.getElementById('modalImage');
            img.src = src;
            currentScale = 1;
            updateZoom();
            imageModalInstance.show();
        }

        function zoom(delta) {
            currentScale = Math.min(Math.max(currentScale + delta, minScale), maxScale);
            updateZoom();
        }

        function updateZoom() {
            const img = document.getElementById('modalImage');
            const txt = document.getElementById('zoomLevelDisplay');
            img.style.transform = `scale(${currentScale})`;
            txt.innerText = Math.round(currentScale * 100) + '%';
        }

        // --- UTILS ---
        function setLoading(isLoading) {
            document.getElementById('uploadBtn').disabled = isLoading;
            const spinner = document.getElementById('uploadSpinner');
            isLoading ? spinner.classList.remove('hidden') : spinner.classList.add('hidden');
        }

        function updateStatus(title, msg, pct) {
            const el = document.getElementById('processingStatus');
            el.classList.remove('hidden');
            document.getElementById('processingTitle').innerText = title;
            document.getElementById('processingMessage').innerText = msg;
            document.getElementById('processingProgress').style.width = pct + '%';
        }

        function toBase64(file) {
            return new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => res(r.result);
                r.onerror = rej;
                r.readAsDataURL(file);
            });
        }

        function fixB64(str) {
            return str.startsWith('data:') ? str : `data:image/png;base64,${str}`;
        }

        function showSuccess(m) {
            notify(m, 'green');
        }

        function showError(m) {
            notify(m, 'red');
        }

        function showWarning(m) {
            notify(m, 'yellow');
        }

        function notify(msg, color) {
            const res = document.getElementById('uploadResult');
            // Tailwind alerts
            const colors = {
                green: 'bg-green-900/50 border-green-500 text-green-200',
                red: 'bg-red-900/50 border-red-500 text-red-200',
                yellow: 'bg-yellow-900/50 border-yellow-500 text-yellow-200'
            };
            res.innerHTML = `
            <div class="p-4 rounded-lg border flex items-center gap-3 ${colors[color]} animate-fade-in">
                <i class="bi bi-info-circle-fill"></i> ${msg}
            </div>
        `;
        }

        window.clearAllReferenceData = function () {
            if (confirm('Cancellare tutto?')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
{% endblock %}