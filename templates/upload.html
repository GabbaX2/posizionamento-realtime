{% extends "base.html" %}

{% block title %}Carica Riferimento - Sensor Placement Validator{% endblock %}

{% block content %}
    <div class="upload-section">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="text-center mb-4 mb-md-5">
                    <div class="upload-icon bg-primary rounded-circle mx-auto mb-3">
                        <i class="bi bi-cloud-upload fs-1 text-white"></i>
                    </div>
                    <h1 class="display-6 display-md-5 fw-bold text-dark mb-2 mb-md-3">Carica Immagine di
                        Riferimento</h1>
                    <p class="lead text-muted d-none d-md-block">Carica un'immagine della gamba (vista anteriore o
                        posteriore)
                    </p>
                    <p class="text-muted d-md-none">Carica l'immagine di riferimento</p>
                </div>

                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-header bg-gradient-primary text-white py-3">
                        <h4 class="mb-0 fs-5 fs-md-4">
                            <i class="bi bi-gear me-2"></i>Configurazione Riferimento
                        </h4>
                    </div>
                    <div class="card-body p-3 p-md-4">
                        <form id="uploadForm" enctype="multipart/form-data" class="needs-validation" novalidate>

                            <input type="hidden" name="limb_type" value="leg">
                            <input type="hidden" name="view_type" value="anterior">
                            <div class="mb-4">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="removeBackground"
                                                   checked>
                                            <label class="form-check-label fw-semibold" for="removeBackground">
                                                <i class="bi bi-scissors me-2 text-info"></i>Rimuovi automaticamente lo
                                                sfondo
                                            </label>
                                            <div class="form-text mt-2">
                                                Richiesto per l'analisi dei contorni. Lo sfondo verr√† rimosso per
                                                permettere l'analisi.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="referenceImage" class="form-label fw-semibold text-dark mb-3">
                                    <i class="bi bi-image me-2 text-primary"></i>Immagine di Riferimento
                                </label>

                                <div
                                        class="file-upload-area border-2 border-dashed rounded-3 p-4 p-md-5 text-center bg-light position-relative">
                                    <i class="bi bi-cloud-arrow-up d-block fs-1 text-muted mb-3 mb-md-4"></i>
                                    <h5 class="text-dark mb-2 mb-md-3 fs-6 fs-md-5">Trascina l'immagine qui</h5>
                                    <p class="text-muted mb-3 mb-md-4 fs-7">oppure</p>

                                    <div class="d-flex justify-content-center">
                                        <input class="form-control d-none" type="file" id="referenceImage" name="file"
                                               accept="image/*" required>
                                        <button type="button"
                                                class="btn btn-primary px-4 px-md-5 py-2 py-md-3 touch-target"
                                                onclick="document.getElementById('referenceImage').click()">
                                            <i class="bi bi-folder2-open me-2"></i>Scegli File
                                        </button>
                                    </div>

                                    <div class="form-text mt-3 mt-md-4 fs-7">
                                        Formati supportati: JPG, PNG, WebP - Dimensione massima: 10MB
                                    </div>
                                </div>

                                <div id="fileInfo" class="mt-3" style="display: none;">
                                    <div class="alert alert-info d-flex align-items-center py-2">
                                        <i class="bi bi-info-circle me-2 flex-shrink-0"></i>
                                        <span id="fileName" class="fs-7"></span>
                                    </div>
                                </div>
                            </div>

                            <div id="processingStatus" class="mb-4" style="display: none;">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-warning me-3"
                                                 role="status">
                                                <span class="visually-hidden">Elaborazione...</span>
                                            </div>
                                            <div>
                                                <h6 class="mb-1 fw-semibold" id="processingTitle">Elaborazione in
                                                    corso...</h6>
                                                <small class="text-muted" id="processingMessage">Attendere prego</small>
                                            </div>
                                        </div>
                                        <div class="progress mt-3" style="height: 6px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                                 role="progressbar" style="width: 0%" id="processingProgress"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg py-3 touch-target" id="uploadBtn">
                                    <i class="bi bi-cloud-upload me-2"></i>
                                    <span class="upload-text">Carica Immagine</span>
                                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"
                                         id="uploadSpinner">
                                        <span class="visually-hidden">Caricamento...</span>
                                    </div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="uploadResult" class="mt-3"></div>

                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-danger" onclick="clearAllReferenceData()">
                        <i class="bi bi-trash3"></i> Cancella Riferimento Salvato
                    </button>
                </div>

                <div id="referencePreview" class="mt-4" style="display: none;">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light py-3">
                            <h4 class="mb-0 text-dark fs-5 fs-md-4">
                                <i class="bi bi-eye me-2 text-primary"></i>Anteprima Immagine Caricata
                            </h4>
                        </div>
                        <div class="card-body p-3 p-md-4">
                            <div class="text-center position-relative">
                                <img id="previewImage" src="" alt="Preview dell'immagine di riferimento"
                                     class="img-fluid rounded shadow preview-image touch-target"
                                     style="max-height: 50vh; min-height: 200px; cursor: zoom-in;">
                                <div class="mt-2">
                                    <small class="text-muted fs-7">
                                        <i class="bi bi-zoom-in me-1"></i>Tocca per ingrandire
                                    </small>
                                </div>
                            </div>

                            <div id="previewInfo" class="row mt-3 mt-md-4 text-center g-2">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="detectionResults" class="mt-4" style="display: none;">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-gradient-primary text-white py-3">
                            <h4 class="mb-0 text-white fs-5 fs-md-4">
                                <i class="bi bi-geo-alt me-2"></i>Contorni e Sensori Rilevati
                            </h4>
                        </div>
                        <div class="card-body p-3 p-md-4">
                            <ul class="nav nav-tabs mb-3" id="imageTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="original-tab" data-bs-toggle="tab"
                                            data-bs-target="#original-pane" type="button" role="tab">
                                        <i class="bi bi-image me-1"></i>Originale (Sfondo Rimosso)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="annotated-tab" data-bs-toggle="tab"
                                            data-bs-target="#annotated-pane" type="button" role="tab">
                                        <i class="bi bi-lightbulb-fill me-1"></i>Con Rilevamento
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="imageTabsContent">
                                <div class="tab-pane fade show active" id="original-pane" role="tabpanel">
                                    <div class="text-center">
                                        <img id="originalImage" src="" alt="Immagine originale"
                                             class="img-fluid rounded shadow"
                                             style="max-height: 60vh; cursor: zoom-in;">
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="annotated-pane" role="tabpanel">
                                    <div class="text-center">
                                        <img id="annotatedImage" src="" alt="Immagine con rilevamento"
                                             class="img-fluid rounded shadow"
                                             style="max-height: 60vh; cursor: zoom-in;">
                                    </div>

                                    <div class="mt-4">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body p-4">
                                                <h5 class="mb-4">
                                                    <i class="bi bi-info-circle-fill text-primary me-2"></i>
                                                    Legenda Annotazioni
                                                </h5>

                                                <div class="row g-4">
                                                    <div class="col-md-6">
                                                        <div class="border-start border-4 border-success ps-3">
                                                            <h6 class="fw-bold mb-3">
                                                                <i class="bi bi-check-circle me-2"></i>
                                                                Contorno della Gamba
                                                            </h6>
                                                            <div class="d-flex align-items-center">
                                                    <span class="me-3" style="
                                                        width: 20px;
                                                        height: 20px;
                                                        border: 3px solid #00ff00; /* Verde */
                                                        display: inline-block;
                                                    "></span>
                                                                <div>
                                                                    <strong>Verde</strong>
                                                                    <small class="d-block text-muted">Contorno
                                                                        principale
                                                                        rilevato</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <div class="border-start border-4 border-danger ps-3">
                                                            <h6 class="fw-bold mb-3">
                                                                <i class="bi bi-bullseye me-2"></i>
                                                                Posizioni Sensori
                                                            </h6>
                                                            <div class="d-flex flex-column gap-3" id="sensorLegend">
                                                                <div class="d-flex align-items-center">
                                                        <span class="me-3" style="
                                                            width: 20px;
                                                            height: 20px;
                                                            border-radius: 50%;
                                                            border: 3px solid #ff0000; /* Rosso */
                                                            position: relative;
                                                            display: inline-block;
                                                        ">
                                                            <span style="
                                                                position: absolute;
                                                                top: 50%;
                                                                left: 50%;
                                                                transform: translate(-50%, -50%);
                                                                width: 6px;
                                                                height: 6px;
                                                                border-radius: 50%;
                                                                background-color: #ffff00; /* Giallo */
                                                            "></span>
                                                        </span>
                                                                    <div>
                                                                        <strong>Rosso (Esterno) / Giallo
                                                                            (Centro)</strong>
                                                                        <small class="d-block text-muted">Sensori
                                                                            (Cerchi)
                                                                            Rilevati</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mt-4 pt-3 border-top">
                                                    <div class="alert alert-light mb-0">
                                                        <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                                                        <strong>Come leggere l'immagine:</strong>
                                                        <ul class="mb-0 mt-2 small">
                                                            <li>Il <strong>contorno verde</strong> evidenzia la forma
                                                                della gamba.
                                                            </li>
                                                            <li>I <strong>cerchi rossi con il centro giallo</strong>
                                                                indicano le
                                                                posizioni dei sensori rilevati.
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 bg-light mt-4">
                    <div class="card-body p-3 p-md-4">
                        <h5 class="card-title text-dark mb-3 fs-5 fs-md-4">
                            <i class="bi bi-question-circle me-2 text-primary"></i>Linee Guida
                        </h5>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <ul class="list-unstyled mb-3 mb-md-0">
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-check-circle text-success me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">Buona illuminazione</span>
                                    </li>
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-check-circle text-success me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">Posizione naturale</span>
                                    </li>
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-check-circle text-success me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">Tutti i sensori visibili</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-12 col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-x-circle text-danger me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">No immagini sfocate</span>
                                    </li>
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-x-circle text-danger me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">No ostacoli sui sensori</span>
                                    </li>
                                    <li class="mb-2 d-flex align-items-start">
                                        <i class="bi bi-x-circle text-danger me-2 mt-1 flex-shrink-0"></i>
                                        <span class="fs-7">No angolazioni estreme</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
                <div class="modal-header bg-dark border-bottom-0 py-3">
                    <h5 class="modal-title text-white fs-6" id="imageModalLabel">
                        <i class="bi bi-zoom-in me-2"></i>Anteprima Dettagliata
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi">
                    </button>
                </div>
                <div class="modal-body p-0 d-flex align-items-center justify-content-center position-relative">
                    <div class="image-container position-relative" style="touch-action: none;">
                        <img id="modalImage" src="" alt="Immagine ingrandita" class="img-fluid"
                             style="max-height: 80vh; max-width: 100%;">
                    </div>

                    <div
                            class="zoom-controls-mobile position-absolute bottom-0 start-50 translate-middle-x mb-3 d-flex gap-2 bg-dark bg-opacity-75 rounded-pill p-2">
                        <button type="button" class="btn btn-outline-light btn-sm rounded-circle touch-target-zoom"
                                id="zoomOutMobile" aria-label="Riduci zoom">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm rounded-circle touch-target-zoom"
                                id="zoomResetMobile" aria-label="Reimposta zoom">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm rounded-circle touch-target-zoom"
                                id="zoomInMobile" aria-label="Aumenta zoom">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-footer bg-dark border-top-0 py-3">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <button type="button" class="btn btn-outline-light touch-target" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>Chiudi
                        </button>
                        <div class="d-none d-md-flex gap-2">
                            <button type="button" class="btn btn-outline-light btn-sm touch-target" id="zoomOut">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm touch-target" id="zoomReset">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm touch-target" id="zoomIn">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <style>
        .upload-section {
            padding: 1rem 0;
        }

        .upload-icon {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%) !important;
        }

        .file-upload-area {
            border-color: #dee2e6 !important;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .file-upload-area:hover {
            border-color: #3498db !important;
            background-color: #f8f9fa !important;
        }

        .file-upload-area.dragover {
            border-color: #3498db !important;
            background-color: #e3f2fd !important;
        }

        .limb-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 100px;
        }

        .limb-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .limb-option .form-check-input {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .limb-option .form-check-label {
            padding-left: 2rem !important;
            cursor: pointer;
            width: 100%;
        }

        .form-check-input:checked + .form-check-label {
            background-color: #e3f2fd;
            border-radius: 8px;
        }

        .preview-stats {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .preview-image {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
            object-fit: contain;
        }

        .preview-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }

        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .touch-target-zoom {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fs-7 {
            font-size: 0.8rem !important;
        }

        /* Stile per le icone dei sensori nella legenda - adattato per cerchi rossi/gialli */
        .sensor-icon-legend {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #ff0000; /* Rosso esterno */
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background-color: transparent; /* per vedere l'immagine sotto se necessario */
        }

        .sensor-icon-legend::after {
            content: '';
            position: absolute;
            width: 8px; /* dimensione centro giallo */
            height: 8px;
            background-color: #ffff00; /* Giallo centro */
            border-radius: 50%;
        }

        /* Stile per il contorno gamba nella legenda */
        .contour-icon-legend {
            width: 30px;
            height: 30px;
            border: 3px solid #00ff00; /* Verde */
            display: inline-block;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .file-upload-area {
                min-height: 200px;
                padding: 2rem 1rem !important;
            }
        }
    </style>

    <script>
        console.log('üöÄ Inizializzazione upload.html - v_singola_api');

        // Funzione per rimuovere lo sfondo
        async function removeImageBackground(imageBase64) {
            console.log('üîÑ Invio richiesta rimozione sfondo...');

            updateProcessingStatus('Rimozione sfondo in corso...', 'Elaborazione con AI...', 30);

            try {
                const response = await fetch('/api/remove_background', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_base64: imageBase64,
                        use_preprocess: true,
                        resize_max: 1024,
                        grabcut_if_failed: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Sfondo rimosso con successo usando:', result.method);
                    updateProcessingStatus('Sfondo rimosso!', `Metodo: ${result.method}`, 60);
                    // Ritorna l'immagine base64 con prefisso data:
                    return result.image_base64;
                } else {
                    console.error('‚ùå Errore rimozione sfondo:', result.error);
                    showWarning('‚ö†Ô∏è Impossibile rimuovere lo sfondo, uso immagine originale');
                    return imageBase64; // Ritorna l'originale
                }
            } catch (error) {
                console.error('‚ùå Errore durante la rimozione dello sfondo:', error);
                showWarning('‚ö†Ô∏è Errore nella rimozione sfondo, uso immagine originale');
                return imageBase64; // Ritorna l'originale
            }
        }

        function updateProcessingStatus(title, message, progress) {
            const statusDiv = document.getElementById('processingStatus');
            const titleEl = document.getElementById('processingTitle');
            const messageEl = document.getElementById('processingMessage');
            const progressBar = document.getElementById('processingProgress');

            if (statusDiv && titleEl && messageEl && progressBar) {
                statusDiv.style.display = 'block';
                titleEl.textContent = title;
                messageEl.textContent = message;
                progressBar.style.width = progress + '%';
            }
        }

        function hideProcessingStatus() {
            const statusDiv = document.getElementById('processingStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Global variables
        let imageModalInstance = null;
        let currentScale = 1;
        const minScale = 0.5;
        const maxScale = 5;
        const scaleStep = 0.25;

        // Initialization
        document.addEventListener('DOMContentLoaded', function () {
            console.log('‚úÖ DOM loaded, inizializzazione componenti...');
            initializeUploadForm();
            initializeImageModal();
        });

        function initializeUploadForm() {
            const uploadForm = document.getElementById('uploadForm');
            const fileUploadArea = document.querySelector('.file-upload-area');
            const fileInput = document.getElementById('referenceImage');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');

            // Touch handling for upload area
            if (fileUploadArea) {
                fileUploadArea.addEventListener('touchstart', function (e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                fileUploadArea.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    fileInput.click();
                });

                // Drag and drop for desktop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, unhighlight, false);
                });

                fileUploadArea.addEventListener('drop', handleDrop, false);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                fileUploadArea.classList.add('dragover');
            }

            function unhighlight() {
                fileUploadArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                handleFiles(files);
            }

            // File selection handling
            if (fileInput) {
                fileInput.addEventListener('change', function (e) {
                    handleFiles(this.files);
                });
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    fileName.textContent = `File selezionato: ${file.name} (${fileSize} MB)`;
                    fileInfo.style.display = 'block';

                    console.log(`üìÅ File selezionato: ${file.name} (${fileSize} MB)`);

                    const limbType = document.querySelector('input[name="limb_type"]').value;

                    // Read and preview image
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        console.log('üì§ Mostra anteprima immagine...');

                        // Display preview
                        const previewDiv = document.getElementById('referencePreview');
                        const previewImg = document.getElementById('previewImage');

                        if (previewDiv && previewImg) {
                            previewImg.src = e.target.result;
                            previewDiv.style.display = 'block';

                            // Update stats
                            updateImageInfo(file, limbType, "Gamba");

                            // Show preview success indicator
                            const previewCard = previewDiv.querySelector('.card');
                            if (previewCard) {
                                previewCard.classList.add('border-info');
                                previewCard.style.borderWidth = '2px';
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Form submission
            if (uploadForm) {
                uploadForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const uploadBtn = document.getElementById('uploadBtn');
                    const uploadSpinner = document.getElementById('uploadSpinner');
                    const removeBackgroundCheckbox = document.getElementById('removeBackground');

                    if (!fileInput.files || fileInput.files.length === 0) {
                        showError('‚ùå Seleziona un\'immagine prima di caricare');
                        return;
                    }

                    // [MODIFICA] Puliamo il localStorage manualmente
                    try {
                        localStorage.removeItem('cleanReferenceImage');
                        localStorage.removeItem('validationOverlayImage');
                        localStorage.removeItem('referenceImage');
                        localStorage.removeItem('referenceMetadata');
                        console.log('üóëÔ∏è Dati di riferimento precedenti rimossi dal localStorage');
                    } catch (error) {
                        console.error('Errore pulizia localStorage:', error);
                    }


                    // Show spinner and disable button
                    uploadBtn.disabled = true;
                    uploadSpinner.classList.remove('d-none');
                    updateProcessingStatus('Preparazione...', 'Lettura file...', 10);

                    try {
                        // Read file as base64
                        const file = fileInput.files[0];
                        let imageBase64 = await fileToBase64(file); // Questa √® l'immagine originale

                        let imageBase64_processed = imageBase64;

                        // Remove background if enabled
                        if (removeBackgroundCheckbox.checked) {
                            console.log('üîÑ Rimozione sfondo abilitata');
                            imageBase64_processed = await removeImageBackground(imageBase64);
                        } else {
                            console.log('‚ÑπÔ∏è Rimozione sfondo disabilitata');
                            updateProcessingStatus('Preparazione completata', 'Sfondo non rimosso', 60);
                            showWarning('Attenzione: la rimozione sfondo √® disabilitata. L\'analisi richiede uno sfondo trasparente.');
                        }

                        // Update preview with processed image
                        const previewImg = document.getElementById('previewImage');
                        if (previewImg) {
                            previewImg.src = imageBase64_processed;
                        }

                        updateProcessingStatus('Caricamento e Analisi...', 'Invio al server...', 70);

                        const formData = new FormData();
                        // Convertiamo l'immagine processata (BGRA) in blob per l'upload
                        const blob = await base64ToBlob(imageBase64_processed);
                        formData.append('file', blob, file.name);
                        formData.append('session_id', 'default');

                        const response = await fetch('/api/upload_reference', {
                            method: 'POST',
                            body: formData
                        });

                        const uploadResult = await response.json();

                        if (!response.ok || !uploadResult.success) {
                            const errorMsg = uploadResult.error || `HTTP error! status: ${response.status}`;
                            throw new Error(errorMsg);
                        }

                        console.log('‚úÖ Upload e Analisi completati:', uploadResult);

                        // [MODIFICA CHIAVE] STEP 2: Salvare i DATI CORRETTI su localStorage
                        updateProcessingStatus('Salvataggio locale...', 'Quasi fatto...', 90);

                        try {
                            // Immagine PULITA (da uploadResult) per la validazione backend (SSIM, MSE)
                            const cleanReferenceBase64 = uploadResult.reference_image.startsWith('data:')
                                ? uploadResult.reference_image
                                : `data:image/png;base64,${uploadResult.reference_image}`;

                            // Immagine DISEGNO (da uploadResult) per l'overlay frontend
                            const overlayBase64 = uploadResult.drawing_overlay_image.startsWith('data:')
                                ? uploadResult.drawing_overlay_image
                                : `data:image/png;base64,${uploadResult.drawing_overlay_image}`;

                            localStorage.setItem('cleanReferenceImage', cleanReferenceBase64);
                            localStorage.setItem('validationOverlayImage', overlayBase64);

                            const metadata = {
                                fileName: file.name,
                                uploadDate: new Date().toISOString(),
                                session_id: uploadResult.session_id,
                                sensorsFound: uploadResult.sensors_found,
                                backgroundRemoved: removeBackgroundCheckbox.checked,
                                sensors_data: uploadResult.sensors_data // <--- AGGIUNTO: Salva le coordinate per i cerchi verdi!
                            };
                            localStorage.setItem('referenceMetadata', JSON.stringify(metadata));

                            console.log('üíæ Dati salvati nel localStorage, incluso sensors_data');

                        } catch (error) {
                            if (error.name === 'QuotaExceededError') {
                                console.error('‚ùå localStorage pieno!');
                                showError('Immagine troppo grande per il localStorage.');
                            } else {
                                console.error('‚ùå Errore salvataggio localStorage:', error);
                            }
                            hideProcessingStatus();
                            return; // Interrompi se non possiamo salvare
                        }

                        updateProcessingStatus('Completato!', 'Tutto pronto', 100);

                        displayDetectionResults(uploadResult);

                        // Show success banner
                        const previewDiv = document.getElementById('referencePreview');
                        const successBanner = `
                            <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                                <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                                <div>
                                    <h5 class="alert-heading mb-1">Immagine Caricata con Successo!</h5>
                                    <p class="mb-0">Il tuo riferimento √® stato salvato e analizzato.</p>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        previewDiv.insertAdjacentHTML('afterbegin', successBanner);
                        showSuccess('‚úÖ Immagine caricata con successo!');

                        previewDiv.scrollIntoView({behavior: 'smooth', block: 'start'});

                        const previewCard = previewDiv.querySelector('.card');
                        if (previewCard) {
                            previewCard.classList.remove('border-info');
                            previewCard.classList.add('border-success');
                            previewCard.style.borderWidth = '2px';
                        }

                        setTimeout(hideProcessingStatus, 2000);

                    } catch (error) {
                        console.error('‚ùå Errore durante il processo:', error);
                        showError('‚ùå Errore: ' + error.message);
                        hideProcessingStatus();
                    } finally {
                        uploadBtn.disabled = false;
                        uploadSpinner.classList.add('d-none');
                    }
                });
            }

            // Funzione per cancellare, ora pulisce le 3 chiavi corrette
            window.clearAllReferenceData = function (showConfirm = true) {
                const doClear = () => {
                    try {
                        localStorage.removeItem('cleanReferenceImage');
                        localStorage.removeItem('validationOverlayImage');
                        localStorage.removeItem('referenceImage');
                        localStorage.removeItem('referenceMetadata');
                        console.log('üóëÔ∏è Dati di riferimento rimossi dal localStorage');
                    } catch (error) {
                        console.error('Errore pulizia localStorage:', error);
                    }

                    const previewDiv = document.getElementById('referencePreview');
                    if (previewDiv) previewDiv.style.display = 'none';
                    const detectionResultsDiv = document.getElementById('detectionResults');
                    if (detectionResultsDiv) detectionResultsDiv.style.display = 'none';
                    const uploadForm = document.getElementById('uploadForm');
                    if (uploadForm) uploadForm.reset();
                    const fileInfo = document.getElementById('fileInfo');
                    if (fileInfo) fileInfo.style.display = 'none';

                    hideProcessingStatus();

                    if (showConfirm) {
                        showSuccess('üóëÔ∏è Tutti i dati di riferimento sono stati cancellati!');
                    }
                };

                if (showConfirm) {
                    if (confirm('Sei sicuro di voler cancellare tutti i dati di riferimento salvati?')) {
                        doClear();
                    }
                } else {
                    doClear();
                }
            };
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Helper function to convert base64 to blob
        async function base64ToBlob(base64Data) {
            // Rimuovi il prefisso data: se presente
            if (base64Data.startsWith('data:')) {
                base64Data = base64Data.split(',')[1];
            }
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            // Il mime-type DEVE essere image/png perch√© stiamo inviando
            // un'immagine BGRA processata
            return new Blob([byteArray], {type: 'image/png'});
        }

        function updateImageInfo(file, limbType, viewType) {
            const previewInfo = document.getElementById('previewInfo');
            const fileSize = (file.size / 1024 / 1024).toFixed(2);

            let viewText = viewType || 'Sconosciuto';

            previewInfo.innerHTML = `
            <div class="col-md-4 col-6">
                <div class="preview-stats h-100">
                    <span class="stat-value text-primary" style="font-size: 1rem; word-break: break-all;">${file.name}</span>
                    <span class="stat-label">Nome File</span>
                </div>
            </div>
            <div class="col-md-4 col-6">
                <div class="preview-stats h-100">
                    <span class="stat-value text-success">${fileSize} MB</span>
                    <span class="stat-label">Dimensione</span>
                </div>
            </div>
            <div class="col-md-4 col-12">
                <div class="preview-stats h-100">
                    <span class="stat-value text-info">${viewText}</span>
                    <span class="stat-label">Tipo di Vista</span>
                </div>
            </div>
        `;
        }

        function displayDetectionResults(result) {
            console.log('üéØ Mostrando risultati rilevamento contorni e sensori...');

            const detectionResultsDiv = document.getElementById('detectionResults');
            if (!detectionResultsDiv) {
                console.warn('‚ö†Ô∏è Div detectionResults non trovato');
                return;
            }

            // Mostra il div
            detectionResultsDiv.style.display = 'block';

            // Popola le immagini
            const originalImg = document.getElementById('originalImage');
            const annotatedImg = document.getElementById('annotatedImage');

            // 'result.reference_image' √® l'immagine pulita (Sfondo Rimosso)
            if (originalImg && result.reference_image) {
                originalImg.src = result.reference_image.startsWith('data:')
                    ? result.reference_image
                    : `data:image/png;base64,${result.reference_image}`;
            }

            // 'result.annotated_image' √® l'immagine con disegni sopra
            if (annotatedImg && result.annotated_image) {
                annotatedImg.src = result.annotated_image.startsWith('data:')
                    ? result.annotated_image
                    : `data:image/png;base64,${result.annotated_image}`;

                // Attiva automaticamente il tab annotato
                const annotatedTab = document.getElementById('annotated-tab');
                if (annotatedTab) {
                    setTimeout(() => {
                        new bootstrap.Tab(annotatedTab).show();
                    }, 500);
                }
            }

            // Aggiungi zoom alle immagini
            if (originalImg) {
                originalImg.addEventListener('click', function () {
                    openImageInModal(this.src);
                });
            }
            if (annotatedImg) {
                annotatedImg.addEventListener('click', function () {
                    openImageInModal(this.src);
                });
            }

            // Aggiorna le statistiche sui contorni e sensori
            updateDetectionInfo(result.contours_found, result.sensors_found);


            // Scroll to results
            detectionResultsDiv.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Funzione per aggiornare le info di rilevamento
        function updateDetectionInfo(contoursCount, sensorsCount) {
            const targetDiv = document.querySelector('#detectionResults .card-body');
            if (!targetDiv) return;

            const existingInfo = targetDiv.querySelector('.detection-stats-card');
            if (existingInfo) existingInfo.remove(); // Rimuovi se gi√† presente

            const infoHTML = `
            <div class="alert alert-info detection-stats-card">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-0">Rilevamento Contorni e Sensori Completato</h6>
                        <small>Metodo: OpenCV (Hough Circles)</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center g-2">
                    <div class="col-6">
                        <div class="p-2 bg-white rounded">
                            <strong class="d-block text-primary fs-4">${contoursCount || 'N/A'}</strong>
                            <small class="text-muted">Contorni Rilevati</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-white rounded">
                            <strong class="d-block text-success fs-4">${sensorsCount || 0}</strong>
                            <small class="text-muted">Sensori Rilevati</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
            targetDiv.insertAdjacentHTML('afterbegin', infoHTML);
        }

        // Funzione per aprire immagine nel modal
        function openImageInModal(imageSrc) {
            const modalImage = document.getElementById('modalImage');
            if (modalImage && imageModalInstance) {
                modalImage.src = imageSrc;
                imageModalInstance.show();
                resetZoom();
            }
        }

        function initializeImageModal() {
            const previewImage = document.getElementById('previewImage');
            const modalElement = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            if (!modalElement) {
                console.warn('‚ö†Ô∏è Modal elemento non trovato');
                return;
            }

            // Initialize Bootstrap modal
            imageModalInstance = new bootstrap.Modal(modalElement);

            // Click on preview to open modal
            if (previewImage) {
                previewImage.addEventListener('click', function () {
                    if (this.src && this.src !== '') {
                        modalImage.src = this.src;
                        imageModalInstance.show();
                        resetZoom();
                        console.log('üîç Modal aperto per zoom');
                    }
                });
            }

            // Zoom controls
            setupZoomControls();

            // Touch zoom (pinch)
            let initialDistance = 0;
            let currentDistance = 0;

            modalImage.addEventListener('touchstart', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                }
            });

            modalImage.addEventListener('touchmove', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    currentDistance = getDistance(e.touches[0], e.touches[1]);

                    if (initialDistance > 0) {
                        const scale = currentDistance / initialDistance;
                        const newScale = Math.min(Math.max(currentScale * scale, minScale), maxScale);
                        applyZoom(newScale);
                        initialDistance = currentDistance;
                    }
                }
            });

            modalImage.addEventListener('touchend', function (e) {
                if (e.touches.length < 2) {
                    initialDistance = 0;
                }
            });

            function getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        function setupZoomControls() {
            // Desktop controls
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const zoomReset = document.getElementById('zoomReset');

            // Mobile controls
            const zoomInMobile = document.getElementById('zoomInMobile');
            const zoomOutMobile = document.getElementById('zoomOutMobile');
            const zoomResetMobile = document.getElementById('zoomResetMobile');

            if (zoomIn) zoomIn.addEventListener('click', () => zoom(scaleStep));
            if (zoomOut) zoomOut.addEventListener('click', () => zoom(-scaleStep));
            if (zoomReset) zoomReset.addEventListener('click', resetZoom);

            if (zoomInMobile) zoomInMobile.addEventListener('click', () => zoom(scaleStep));
            if (zoomOutMobile) zoomOutMobile.addEventListener('click', () => zoom(-scaleStep));
            if (zoomResetMobile) zoomResetMobile.addEventListener('click', resetZoom);
        }

        function zoom(delta) {
            const newScale = Math.min(Math.max(currentScale + delta, minScale), maxScale);
            applyZoom(newScale);
        }

        function applyZoom(scale) {
            currentScale = scale;
            const modalImage = document.getElementById('modalImage');
            if (modalImage) {
                modalImage.style.transform = `scale(${currentScale})`;
                modalImage.style.transition = 'transform 0.2s ease';
            }
        }

        function resetZoom() {
            currentScale = 1;
            const modalImage = document.getElementById('modalImage');
            if (modalImage) {
                modalImage.style.transform = 'scale(1)';
            }
        }

        // Utility functions for notifications
        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'danger');
        }

        function showWarning(message) {
            showNotification(message, 'warning');
        }

        function showNotification(message, type) {
            const uploadResult = document.getElementById('uploadResult');
            if (!uploadResult) return;

            const iconMap = {
                'success': 'check-circle',
                'danger': 'x-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };

            const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="bi bi-${iconMap[type] || 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

            uploadResult.innerHTML = alertHTML;

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = uploadResult.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        console.log('‚úÖ Script upload.html con vista anteriore/posteriore caricato');
    </script>
{% endblock %}